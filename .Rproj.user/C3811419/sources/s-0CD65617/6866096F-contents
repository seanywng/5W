---
title: "Report on Education 5W data -- Venezuela"
author: "Sean Ng"
date: "`r format(Sys.Date(), format='%d %B, %Y')`"
output:
  html_document:
    toc: yes
    number_sections: yes
    code_download: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 10)
library(tidyverse)
library(lubridate)
library(stringr)
library(pander)
library(scales)
library(forcats)
library(janitor)
library(readxl)
library(ggmap)
library(sf)
library(patchwork)
library(maptools)
library(ggforce)
library(ggthemes)
library(plotly)
library(kableExtra)
library(DT)
library(tinytex)
library(webshot)

# pander thousands separator
panderOptions("big.mark", ",")

# MAKE SURE YOU READ IN THE RIGHT FILE -- CHECK TIMESTAMP
act_ben <- read_csv("211108_0113_act_ben.csv") 
u_ben <- read_csv("211108_0113_u_ben.csv") 

# sum(act_ben$beneficiarios)
# sum(u_ben$beneficiarios)

# census reference datasets
cen_ref <- read_excel("census_data_20191122.xlsx", sheet = "data") %>% 
  clean_names() %>%
  select(estado, pcode1, municipio, pcode2, parroquia, pcode3, field_office,
         poblacion_total_2011, x_2019_poblacion_parroquial_total,
         ham_2019_ambitos_ge, ham_2019_xx_pobreza_env_por_parroquia, 
         ham_2019_xx_poblacion_pobre_por_parroquia,
         poblacion_infantil_menor_de_12_anos, poblacion_adolescentes_de_12_a_17_anos,
         poblacion_de_18_anos_y_mas, 
         poblacion_urbana_percent, area_km2, densidad_poblacional_ppl_km2,
         matricula_2017_educacion_inicial, matricula_2017_educacion_primaria, 
         matricula_2017_educacion_media)

# filtering out PROMOCION MENSAJES CLAVES PARA LA COMUNIDAD ESCOLAR
CA105 <- act_ben %>% filter(actividad_codigo == "CA1.05")

# creating datasets without CA1.05 and
# for act_ben, recoding UNICEF and mutating short activity descriptions
act_ben2 <- act_ben %>% 
  filter(!str_detect(.$ubicacion, "^RADIO")) %>% 
  mutate(organizacion_implementadora = 
           str_replace_all(organizacion_implementadora, 
                           "UNICEF - Fondo de las Naciones Unidas para la Infancia",
                           "UNICEF")) %>% 
  mutate(actividad_short = recode(actividad_codigo, 
                             CA1.01 = "1.01_reinsercion educativa",
                             CA1.02 = "1.02_nivelacion y capacitacion",
                             CA1.03 = "1.03_kits escolares",
                             CA1.04 = "1.04_alimentacion escolar",
                             CA1.05 = "1.05_promocion mensajes claves",
                             CA1.06 = "1.06_apoyo psicoeducativo",
                             CA1.07 = "1.07_actividades recreativas",
                             CA2.08 = "2.08_educacion a distancia",
                             CA2.09 = "2.09_formacion docentes",
                             CA2.10 = "2.10_becas docentes"))
                    
u_ben2 <- u_ben %>% filter(!str_detect(.$ubicacion, "^RADIO"))



```

&nbsp;
&nbsp;

> This demo is an entirely automated report -- all charts and tables, as well as all figures within the text have been generated from the data, with no manual input. This report makes use of the outputs generated by `5W_cleaning.Rmd`, which automates the cleaning of 5W data. The 5W data used has had partner information removed. 

&nbsp; 

# Summary of beneficiaries by activity, with sex ratio 

```{r, summary TABLE -- activity and sex}

# as a note, i don't think you can put an str_detect inside a summarise
panderOptions('table.split.table', Inf)

summary_act <- act_ben2 %>% 
  mutate(sex_ben = ifelse(str_detect(desagregacion, "^m"), "male",
                          ifelse(str_detect(desagregacion, "^f"), "female", "no_esp"))) %>% 
  mutate(actividad = actividad_desc) %>% 
  group_by(actividad) %>% 
  summarise(total = sum(beneficiarios, na.rm = TRUE),
            male = sum((beneficiarios[sex_ben == "male"])),
            female = sum((beneficiarios[sex_ben == "female"])),
            sex_ratio = round((male/female), digits = 2)) %>% 
  mutate(percent_of_total = round((total / sum(total) * 100), digits = 2)) %>% 
  relocate(percent_of_total, .after = total) %>% 
  arrange(desc(total))

pander(summary_act, big.mark = ",", style = "rmarkdown")


```



> A total of __`r format(round(sum(u_ben2$beneficiarios)), big.mark = ",")`__ individuals have been reached to date. In terms of frequencies (inclusive of double counting), __`r format(sum(act_ben2$beneficiarios), big.mark = ",")`__ have been reached. 

> Additionally, the __`r format(sum(CA105$beneficiarios), big.mark = ",")`__ beneficiary frequencies reached by the activity PROMOCION MENSAJES CLAVES PARA LA COMUNIDAD ESCOLAR have been removed from the totals in this report as the activity consists of solely radio messaging. 

&nbsp;
&nbsp;

# Beneficiaries by age
*unique beneficiaries or individuals*

```{r, beneficiaries by age PLOT}
ordvec <- c("0-3", "3-6", "7-12", "12-17", "18-19", "mayor_que_19")

age_u_ben <- u_ben2 %>% # important to use u_ben here 
  mutate(age_ben = case_when(
    str_detect(desagregacion,"0_3$") ~ "0-3",
    str_detect(desagregacion,"3_6$") ~ "3-6",
    str_detect(desagregacion, "7_12$") ~ "7-12", 
    str_detect(desagregacion, "12_17$") ~ "12-17",
    str_detect(desagregacion, "18_19$") ~ "18-19",
    str_detect(desagregacion, "mayores_de_19$") ~ "mayor_que_19", 
    TRUE ~ "no_esp")) %>%
  filter(age_ben != "no_esp") %>% 
  group_by(age_ben) %>% 
  summarise(beneficiarios = sum(beneficiarios))

ggplot(data = age_u_ben, aes(x = fct_reorder(age_ben, ordvec), y = beneficiarios)) +
  geom_col(fill = "cornflowerblue") +
  geom_text(aes(label = scales::comma(beneficiarios)), vjust = -0.25, size = 4) +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = "")) +
  xlab("Grupos por Edad") + ylab("Beneficiarios") +
  theme(axis.text = element_text(size = 10))

```

&nbsp;

## Beneficiaries by age compared to 2017 Enrollment

```{r REF matric ben }
matric_ben <- cen_ref %>% 
  select(matricula_2017_educacion_inicial, matricula_2017_educacion_primaria, 
         matricula_2017_educacion_media) %>%
  rename("3-6" = matricula_2017_educacion_inicial,
         "7-12" = matricula_2017_educacion_primaria,
         "12-17" = matricula_2017_educacion_media) %>% 
  pivot_longer(everything(), names_to = "age_ben", values_to = "matricula2017", 
               values_drop_na = TRUE) %>% 
  group_by(age_ben) %>% 
  summarise(matricula2017 = sum(matricula2017)) %>%
  left_join(age_u_ben) %>% 
  mutate(percent_total = beneficiarios/matricula2017 * 100) %>% 
  relocate(beneficiarios, .after = age_ben) %>% 
  rename(`Edad grupo` = age_ben) %>% 
  slice(2,3,1)  # rearranging rows
  
```

> With reference to the 2017 Matricula dataset, we can see that the Education programme has reached an overall average of __`r round(sum(matric_ben$beneficiarios)/(sum(matric_ben$matricula2017))*100)`%__ of schoolgoing children aged 3-17 nationwide. Children aged 3-17 consitute __`r round(sum(matric_ben$beneficiarios)/(sum(u_ben2$beneficiarios))*100)`%__ of all UNICEF beneficiaries. 

```{r TABLE matric ben}

pander(matric_ben, big.mark = ",", style = "rmarkdown")

```


&nbsp;
&nbsp;

# Changes since previous month

```{r REF cumulative datasets}
cum_u_ben <- u_ben2 %>% 
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  arrange(mes_solo) %>% 
  group_by(mes_solo) %>% 
  summarise(sum_ben = sum(beneficiarios)) %>% 
  mutate(cumulative = cumsum(sum_ben))

cum_act_ben <- act_ben2 %>% 
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  arrange(mes_solo) %>% 
  group_by(mes_solo) %>% 
  summarise(sum_ben = sum(beneficiarios)) %>% 
  mutate(cumulative = cumsum(sum_ben))

```

> The number of individuals reached has increased by __`r format(cum_u_ben[11,3] - cum_u_ben[10,3], big.mark = ",")`__ in the past month, reaching a total of __`r format(round(sum(u_ben2$beneficiarios)), big.mark = ",")`__. The number of beneficiary frequencies reached has increased by __`r format(cum_act_ben[11,3] - cum_act_ben[10,3], big.mark = ",")`__ in the same period, reaching a total of __`r format(sum(cum_act_ben[11,3]), big.mark = ",")`__.

```{r  cumulative beneficiaries line PLOT}
u_ben2 %>% 
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  arrange(mes_solo) %>% 
  group_by(mes_solo) %>% 
  summarise(sum_ben = sum(beneficiarios)) %>% 
  mutate(cumulative = cumsum(sum_ben)) %>% 
  ggplot(aes(x = mes_solo, y = cumulative)) +
  geom_line() +
  geom_text(aes(label = scales::comma(cumulative)), vjust = -0.25, hjust = 1, size = 3) +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  scale_y_continuous(labels = scales::unit_format(unit = "K", scale = 1e-3, sep = ""),
                     breaks = seq(0,950000, by = 200000)) + # what is this breaks doing?
  xlab("Mes Reportado") + ylab("Beneficiarios (cumulativo)")
```

&nbsp;

## Progress by activity by month
*mouse over to see details*

> Progress in recent months has largely been due to the distribution of education kits and distance learning. 

```{r line PLOT progress by activity}
act_lines <- act_ben2 %>% 
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  group_by(actividad_short, mes_solo) %>% 
  summarise(cumulative = sum(beneficiarios)) %>% 
  mutate(cumulative = round(cumsum(cumulative))) %>% 
  ggplot(aes(x = mes_solo, y = cumulative, colour = actividad_short)) +
  geom_line() +
  geom_point(size = 0.7) +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 500000)) +
  xlab("") + ylab("Beneficiarios") +
  scale_colour_discrete(name = "Actividad") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        legend.text = element_text(size = 6)) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))

ggplotly(act_lines, tooltip = c("x", "y", "colour")) %>% 
  layout(showlegend = TRUE, legend = list(font = list(size = 6))) %>% 
   config(displayModeBar = FALSE)
```

&nbsp;
&nbsp;


# Summaries by geography

## Beneficiaries by state

```{r, echo=FALSE}
u_ben2 %>% 
  group_by(estado) %>% 
  summarise(beneficiarios = sum(beneficiarios)) %>%
  ggplot(aes(x = fct_reorder(estado, beneficiarios, .desc = TRUE), 
             y = beneficiarios)) +
  geom_col(fill = "cornflowerblue") +
  ylim(0, 850000) +
  geom_text(aes(label = scales::comma(beneficiarios, accuracy = 1)), 
            vjust = -0.25, hjust = 0.05, size = 3, angle = 30) +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 200000)) +
  xlab("") + ylab("Beneficiarios") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

&nbsp;

```{r REF for ubicacion text}
mira_zul <- u_ben2 %>% filter(estado == "MIRANDA" | 
                              estado == "ZULIA")
```

## Number of Schools by State
> A total of __`r format(n_distinct(u_ben2$ubicacion), big.mark = ",")`__ schools have been reached by UNICEF; __`r round((n_distinct(mira_zul$ubicacion)) / (n_distinct(u_ben2$ubicacion)) * 100)`%__ are from Miranda and Zulia alone. 

```{r PLOT of ubicacion by state}
u_ben2 %>% 
  group_by(estado) %>% 
  distinct(ubicacion) %>% 
  summarise(ubicacion = n()) %>% 
  ggplot(aes(x = fct_reorder(estado, ubicacion, .desc = TRUE), y = ubicacion)) +
  geom_col(fill = "cornflowerblue") +
  geom_text(aes(label = round(ubicacion)), vjust = -0.25, size = 3) + 
  xlab("") + ylab("Numero de Escuelas") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

&nbsp;

```{r REF for all_mun}

# all_mun is one obs per pcode2
all_mun <- u_ben2 %>% 
  mutate(is_matric = case_when( # for beneficiaries aged 3-17
        str_detect(desagregacion,"3_6$") ~ "matric",
        str_detect(desagregacion,"7_12$") ~ "matric",
        str_detect(desagregacion,"12_17$") ~ "matric",
        TRUE ~ "non_matric")) %>% 
  mutate(beneficiarios_3_17 = ifelse(is_matric == "matric", beneficiarios, 0)) %>% 
  group_by(estado, municipio, pcode2) %>% 
  summarise(beneficiarios = round(sum(beneficiarios)),
            beneficiarios_3_17 = round(sum(beneficiarios_3_17))) %>%
  ungroup() %>% 
  left_join(act_ben %>% # bringing activity counts into u_ben
            group_by(pcode2) %>% 
            summarise(act_types = n_distinct(actividad_codigo))) %>% 
  right_join(cen_ref %>% # for bringing matricula2017 into all_mun
            pivot_longer(cols = c("matricula_2017_educacion_inicial",
                              "matricula_2017_educacion_primaria", 
                              "matricula_2017_educacion_media"), 
                     names_to = "age_ben", values_to = "matricula2017", 
                     values_drop_na = TRUE) %>% 
            select(pcode2, age_ben, matricula2017) %>% 
            group_by(pcode2) %>% 
            summarise(matricula2017 = sum(matricula2017))) %>% 
  mutate(coverage_percent = round(beneficiarios_3_17 / matricula2017 * 100)) %>% 
  mutate(estado = fct_reorder(estado, beneficiarios, .desc = TRUE)) %>% 
  arrange(desc(beneficiarios))

```

## Scatterplot of Municipalities
*logarithmic scale; larger points indicate more beneficiaries reached, darker blues indicate more activity types* 

*mouse over municipalities to see beneficiaries and distinct activities*

> A total of __`r n_distinct(u_ben2$pcode2)`__ municipalities were reached by the UNICEF Education programme.

```{r scatterPLOT of municipalities by state}

all_mun_points <- all_mun %>% 
  ggplot(aes(text = municipio, x = estado, y = beneficiarios, 
             colour = act_types)) +
  geom_point(aes(size = beneficiarios), alpha = 0.9) +
  scale_colour_gradient(low = "azure4", high = "darkblue") +
  scale_y_continuous(trans = "log10", 
                     labels = comma) +
  xlab("") + ylab("Beneficiarios Alcanzados por Municipio") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none") 

ggplotly(all_mun_points, tooltip = c("text", "y", "colour")) %>% 
  config(displayModeBar = FALSE)

```

&nbsp;

## Top 10 municipalities by reach and coverage

```{r municipalities top TABLE}
# top municipalities table
top_mun <- all_mun %>% select(estado, municipio, beneficiarios) %>% slice(1:10)

# try to make a table of the most oversubscribed municipalities
top_cov <- all_mun %>% arrange(desc(coverage_percent)) %>% 
  select(estado, municipio, coverage_percent) %>% slice(1:10)

# two tables side by side
kable(top_mun, caption = "by beneficiaries") %>%
  kable_styling(bootstrap_options = "bordered", full_width = FALSE, position = "float_left")
kable(top_cov, caption = "by coverage") %>%
  kable_styling(bootstrap_options = "bordered", full_width = FALSE, position = "left") 

# sum of top ten
top_mun_sum <- all_mun %>% 
  slice(1:10) %>% summarise(sum = sum(beneficiarios, na.rm = TRUE))

all_mun_sum <- all_mun %>% 
  summarise(sum = sum(beneficiarios, na.rm = TRUE))

```

> Together, the 10 municipalities with the highest reach (above left) form __`r round(top_mun_sum / all_mun_sum * 100)`%__ of the __`r format(sum(all_mun$beneficiarios, na.rm = TRUE), big.mark = ",")`__ beneficiaries reached. The average coverage of the school-age population in the municipalities where UNICEF is present is __`r round(mean(all_mun$coverage_percent, na.rm = TRUE))`%__. Coverage refers to the percentage of enrolled children (aged 3-17 years) reached by UNICEF. 

&nbsp;

## Histogram of Coverage

> Below is a histogram of munciipalities where UNICEF is present showing the coverage of enrolled children (aged 3-17). Of note, we have reached 10% or less of the population in __`r sum(all_mun$coverage_percent <= 10, na.rm = TRUE)`__ out of the __`r n_distinct(u_ben2$pcode2)`__ in which we operate. This is in addition to the __`r sum(is.na(all_mun$coverage_percent))`__ where no UNICEF Education activities have occurred. 

```{r PLOT histogram of coverage}
all_mun %>% 
  ggplot(aes(x = coverage_percent)) +
  geom_histogram(binwidth = 5, colour = "black", fill = "white") +
  stat_bin(binwidth = 5, geom = "text", aes(label = ..count..), vjust = -0.5) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90)) +
  ylab("Number of municipalities") + xlab("Percent of enrolled children (3-17) covered")

```

&nbsp;
&nbsp;

# Reports about Partners

## Summary by Partner

```{r PLOT stacked bar partner}
stack_arr <- act_ben2 %>% 
  group_by(organizacion_implementadora) %>% 
  summarise(total = sum(beneficiarios)) %>% 
  arrange(desc(total))

ord_soc <- c("UNICEF", "SOCIO 1", "SOCIO 2", "SOCIO 4", "SOCIO 5", "SOCIO 7", "SOCIO 8",
             "SOCIO 3", "SOCIO 10", "SOCIO 6")

soc_stack <- act_ben2 %>% 
  group_by(actividad_short, organizacion_implementadora) %>% 
  summarise(beneficiarios = round(sum(beneficiarios))) %>%
  ggplot(aes(x = organizacion_implementadora, 
             y = beneficiarios)) +
  geom_col(aes(fill = actividad_short)) +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 400000)) +
  xlab("") + ylab("Beneficiarios") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.key.size = unit(0.1, "cm"),
        legend.position = "bottom",
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 8)) +
  scale_fill_discrete(name = "Actividad") +
  geom_text(data = stack_arr, aes(y = total + 6000, label = scales::comma(total)), 
            size = 3) +
  scale_x_discrete(limits = ord_soc)

ggplotly(soc_stack, tooltip = c("x", "fill", "y")) %>% 
  layout(legend = list(title = list(text = "<b> organizacion <b>"))) %>% 
  config(displayModeBar = FALSE) %>% 
  layout(showlegend = TRUE, legend = list(font = list(size = 6)))


```

&nbsp;

## Number of different activities implemented by each partner

```{r TABLE partner activity count}

panderOptions('table.split.table', Inf)

act_ben %>% 
  mutate(organizacion_implementadora = 
           str_replace_all(organizacion_implementadora, 
                           "UNICEF - Fondo de las Naciones Unidas para la Infancia",
                           "UNICEF")) %>% 
  rename(partner = organizacion_implementadora) %>% 
  group_by(partner) %>% 
  summarise(num_activities = n_distinct(actividad_codigo)) %>% 
  arrange(desc(num_activities)) %>% 
  t() %>% 
  pander()

```

&nbsp;

## Partners' progress over time
*mouse over for details*

```{r line PLOT partners progress}
soc_line <- act_ben2 %>% 
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  group_by(organizacion_implementadora, mes_solo) %>% 
  summarise(cumulative = round(sum(beneficiarios))) %>% 
  mutate(cumulative = cumsum(cumulative)) %>% 
  ggplot(aes(x = mes_solo, y = cumulative, colour = organizacion_implementadora)) +
  geom_line() +
  geom_point(size = 0.7) +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 410000)) +
  xlab("") + ylab("Beneficiarios") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 8))

ggplotly(soc_line, tooltip = c("x", "y", "colour")) %>% 
  layout(legend = list(title = list(text = "<b> organizacion <b>"))) %>% 
  config(displayModeBar = FALSE)
  
```

&nbsp;

## Summary table about partners' achievements

```{r TABLE partners summary}
act_ben2 %>% 
  mutate(sex_ben = ifelse(str_detect(desagregacion, "^m"), "male",
                          ifelse(str_detect(desagregacion, "^f"), "female", "no_esp"))) %>% 
  mutate(actividad = actividad_desc) %>% 
  group_by(organizacion_implementadora) %>% 
  summarise(male = sum((beneficiarios[sex_ben == "male"])),
            female = sum((beneficiarios[sex_ben == "female"])),
            sex_ratio = round((male/female), digits = 2),
            beneficiarios = sum(beneficiarios, na.rm = TRUE)) %>% 
  mutate(percent_of_total = round((beneficiarios / sum(beneficiarios) * 100), digits = 2)) %>% 
  left_join(act_ben %>% 
              mutate(organizacion_implementadora = 
              str_replace_all(organizacion_implementadora, 
                           "UNICEF - Fondo de las Naciones Unidas para la Infancia",
                           "UNICEF")) %>% 
              group_by(organizacion_implementadora) %>% 
              summarise(municipalities = n_distinct(pcode2)), 
     by = "organizacion_implementadora") %>% 
  relocate(beneficiarios, .after = organizacion_implementadora) %>% 
  relocate(percent_of_total, .after = beneficiarios) %>% 
  arrange(desc(beneficiarios)) %>% 
  pander(big.mark = ",", style = "rmarkdown")
```


&nbsp;
&nbsp;

# Maps and reference table

&nbsp;

## Maps at municipal level
```{r MAPS municipal reached and percent reached}
# quiet = TRUE is very important here
pcode2_shape <- st_read("C:/Users/Sean Ng/Documents/R/5W/vnz_adm2_shapefiles/ven_admbnda_adm2_20180502.shp", quiet = TRUE) %>% 
  rename(pcode1 = ADM1_PCODE,
         pcode2 = ADM2_PCODE)

# I think plotly's selector tool is not very good. or maybe the coordinates
# of the ven_admbnda dataset is not very good, at least when it comes to centroids. 

mun_ben_plot <- all_mun %>% 
  right_join(pcode2_shape) %>% 
  st_as_sf() %>% 
  ggplot(aes(fill = beneficiarios)) +
  geom_sf(size = 0.01) +
  theme_void() +
  ggtitle("Number of beneficiaries reached by municipality") +
  scale_fill_gradient(trans = trans_reverser("log"), breaks = c(0, 100, 1000, 10000, 80482),
                      labels = comma, na.value = "gray90") +
  theme(legend.key.size = unit(0.3, "cm"),
        legend.position = c(0.9, 0.1),
        legend.title = element_blank(),
        plot.title = element_text(size = 12))

# fix this to compare schooling age population

mun_percent_plot <- all_mun %>% 
  right_join(pcode2_shape) %>% 
  st_as_sf() %>%
  ggplot(aes(fill = coverage_percent))+
  geom_sf(size = 0.01) +
  theme_void() +
  ggtitle("Percent of enrolled children (3-17) reached by municipality") +
  scale_fill_gradient(labels = comma, trans = "reverse", na.value = "gray90")+
  theme(legend.key.size = unit(0.3, "cm"),
        legend.position = c(0.9, 0.1),
        legend.title = element_blank(), 
        plot.title = element_text(size = 12))

# using patchwork to put them side by side 

mun_ben_plot + mun_percent_plot + plot_layout(ncol = 2)

```

&nbsp;
&nbsp;

## Reference table - municipal level

__use `UNICEF_present` to filter to municipalities where the Education programme operates__

*CA01.05 Promocion de mensajes claves para la comunidad escolar is not included*

```{r DT datatable}
# it shows 335, shouldn't there be 336? I bet it's Vargas again
all_mun %>% 
  mutate(UNICEF_present = ifelse(is.na(beneficiarios), FALSE, TRUE)) %>% 
  rename(no_of_activities = act_types) %>% # I feel like you should have done this earlier
  left_join(cen_ref %>% # additional census variables
      group_by(pcode2) %>% 
      summarise(poor_persons = round(sum(ham_2019_xx_poblacion_pobre_por_parroquia)),
                total_pop    = sum(x_2019_poblacion_parroquial_total)) %>% 
      mutate(poverty_incidence = round(poor_persons / total_pop * 100))) %>% 
  select(!pcode2) %>%
  relocate(UNICEF_present) %>% 
  relocate(poverty_incidence, .after = coverage_percent) %>% 
  relocate(no_of_activities, .after = poverty_incidence) %>%
  datatable(filter = "top", options = list(pageLength = 10, scrollX = TRUE))
  
```


