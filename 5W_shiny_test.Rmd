---
title: "Untitled"
author: "Sean Ng"
date: "11/7/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 9)
library(tidyverse)
library(lubridate)
library(stringr)
library(pander)
library(scales)
library(forcats)
library(janitor)
library(readxl)
library(ggmap)
library(sf)
library(patchwork)
library(maptools)
library(ggforce)
library(ggthemes)
library(plotly)

# pander thousands separator
panderOptions("big.mark", ",")

# make sure you read in the right file -- look at the date

act_ben <- read_csv("211106_1746_act_ben.csv")
u_ben <- read_csv("211106_1746_u_ben.csv")

```

> you need to develop a check if all activities from the same 

```{r, include=FALSE}

# put in eval=FALSE if you don't want them to run in the rmd

sum(act_ben$beneficiarios)
sum(u_ben$beneficiarios)

# for seeing matching pairs (or non-matching ones)
unique(act_ben[c("actividad_codigo", "actividad_desc")]) %>% 
  arrange(actividad_codigo)

# census reference datasets
cen_ref <- read_excel("census_data_20191122.xlsx", sheet = "data") %>% 
  clean_names() %>% 
  select(estado, pcode1, municipio, pcode2, parroquia, pcode3, field_office,
         poblacion_total_2011, x_2019_poblacion_parroquial_total,
         ham_2019_ambitos_ge, ham_2019_xx_pobreza_env_por_parroquia, 
         ham_2019_xx_poblacion_pobre_por_parroquia,
         poblacion_infantil_menor_de_12_anos, poblacion_adolescentes_de_12_a_17_anos,
         poblacion_de_18_anos_y_mas, 
         poblacion_urbana_percent, area_km2, densidad_poblacional_ppl_km2)

```

## Summary of male and female beneficiaries reached by activities: 

```{r, echo=FALSE}

# as a note, i don't think you can put an str_detect inside a summarise

CA105 <- act_ben %>% filter(actividad_codigo == "CA1.05")
panderOptions('table.split.table', Inf)

act_ben %>% 
  filter(actividad_codigo != "CA1.05") %>% # if you want to keep it in
  mutate(sex_ben = ifelse(str_detect(desagregacion, "^m"), "male",
                          ifelse(str_detect(desagregacion, "^f"), "female", "no_esp"))) %>% 
  mutate(actividad = actividad_desc) %>% 
  group_by(actividad) %>% 
  summarise(total = sum(beneficiarios, na.rm = TRUE),
            male = sum((beneficiarios[sex_ben == "male"])),
            female = sum((beneficiarios[sex_ben == "female"])),
            sex_ratio = round((male/female), digits = 2)) %>% 
  mutate(percent_total = round((total / sum(total) * 100), digits = 2)) %>% 
  relocate(percent_total, .after = total) %>% 
  arrange(desc(total)) %>% 
  pander(big.mark = ",", style = "rmarkdown")


```

> Additionally, `r format(sum(CA105$beneficiarios), big.mark = ",")` beneficiaires were reached by the activity PROMOCION MENSAJES CLAVES PARA LA COMUNIDAD ESCOLAR. 

## Number of Beneficiaries summarised by age

```{r, echo=FALSE}
ordvec <- c("0-3", "3-6", "7-12", "12-17", "18-19", "mayor_que_19")

u_ben %>% # important to use u_ben here 
  filter(!str_detect(.$ubicacion, "^RADIO")) %>% # filter out promocion de mensajes claves
  mutate(age_ben = case_when(
    str_detect(desagregacion,"0_3$") ~ "0-3",
    str_detect(desagregacion,"3_6$") ~ "3-6",
    str_detect(desagregacion, "7_12$") ~ "7-12", 
    str_detect(desagregacion, "12_17$") ~ "12-17",
    str_detect(desagregacion, "18_19$") ~ "18-19",
    str_detect(desagregacion, "mayores_de_19$") ~ "mayor_que_19", 
    TRUE ~ "no_esp")) %>%
  filter(age_ben != "no_esp") %>% 
  group_by(age_ben) %>% 
  summarise(beneficiarios = sum(beneficiarios)) %>% 
  ggplot(aes(x = fct_reorder(age_ben, ordvec), y = beneficiarios)) +
  geom_col(fill = "cornflowerblue") +
  geom_text(aes(label = scales::comma(beneficiarios)), vjust = -0.25, size = 4) +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = "")) +
  xlab("Grupos por Edad") + ylab("Beneficiarios") +
  theme(axis.text = element_text(size = 10))

```

### Change since previous month
> you can do this now with act_ben 

> for future reference, you no longer need to create the mes_reportado column in the CSVs, you can do it in this sheet. But maybe just keep it in there. 

```{r}
act_ben %>% 
  filter(actividad_codigo != "CA1.05") %>% # filter out promocion de mensajes claves
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  arrange(mes_solo) %>% 
  group_by(mes_solo) %>% 
  summarise(sum_ben = sum(beneficiarios)) %>% 
  mutate(cumulative = cumsum(sum_ben)) %>% 
  ggplot(aes(x = mes_solo, y = cumulative)) +
  geom_line() +
  geom_text(aes(label = scales::comma(cumulative)), vjust = -0.25, hjust = 1, size = 3) +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  scale_y_continuous(labels = scales::unit_format(unit = "K", scale = 1e-3, sep = ""),
                     breaks = seq(0,950000, by = 200000)) +
  xlab("Mes Reportado") + ylab("Beneficiarios (cumulativo)")
```

> Add another plot where there is one line per activity

```{r}
act_ben %>% 
  filter(actividad_codigo != "CA1.05") %>% # filter out promocion de mensajes claves
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  group_by(actividad_codigo, mes_solo) %>% 
  summarise(cumulative = sum(beneficiarios)) %>% 
  mutate(cumulative = cumsum(cumulative)) %>% 
  ggplot(aes(x = mes_solo, y = cumulative, colour = actividad_codigo)) +
  geom_line() +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 500000)) +
  xlab("") + ylab("Beneficiarios") +
  scale_colour_discrete(name = "Actividad",
                        labels = c("reinsercion educativa", "nivelacion, capacitacion",
                                   "kits escolares", "alimentacion escolar",
                                   "apoyo psicoeducativo", "actividades recreativas",
                                   "educacion a distancia", "formacion docentes",
                                   "becas docentes")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        legend.text = element_text(size = 6)) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```

## Summaries by geography

### Beneficiaries by state

```{r, echo=FALSE}
u_ben %>% 
  group_by(estado) %>% 
  summarise(beneficiarios = sum(beneficiarios)) %>%
  ggplot(aes(x = fct_reorder(estado, beneficiarios, .desc = TRUE), y = beneficiarios)) +
  geom_col(fill = "cornflowerblue") +
  ylim(0, 850000) +
  geom_text(aes(label = scales::comma(beneficiarios)), 
            vjust = -0.25, hjust = 0.05, size = 2.5, angle = 30) +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 810000)) +
  xlab("") + ylab("Beneficiarios") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Number of Schools by State

```{r}
u_ben %>% 
  filter(!str_detect(.$ubicacion, "^RADIO")) %>% # filter out promocion de mensajes claves
  group_by(estado) %>% 
  distinct(ubicacion) %>% 
  summarise(ubicacion = n()) %>% 
  ggplot(aes(x = fct_reorder(estado, ubicacion, .desc = TRUE), y = ubicacion)) +
  geom_col(fill = "cornflowerblue") +
  geom_text(aes(label = round(ubicacion)), vjust = -0.25, size = 2.5) + 
  xlab("") + ylab("Numero de Escuelas/Establecimientos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Scatterplot of Municipalities
*logarithmic scale, larger points indicate more beneficiaries reached*

```{r}
all_mun <- u_ben %>% 
  filter(!str_detect(.$ubicacion, "^RADIO")) %>% # filter out promocion de mensajes claves
  group_by(estado, municipio, pcode2) %>% 
  summarise(beneficiarios = sum(beneficiarios)) %>% 
  ungroup() %>% 
  arrange(desc(beneficiarios))

mun_points <- all_mun %>% 
  ggplot(aes(x = fct_reorder(estado, beneficiarios, .desc = TRUE), y = beneficiarios)) +
  geom_point(aes(size = beneficiarios)) +
  scale_y_continuous(trans = "log10", 
                     labels = comma) +
  xlab("") + ylab("Beneficiarios Alcanzados por Municipio") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none")
 
```

```{r}
ggplotly(mun_points)
```


> A total of `r nrow(all_mun)` municipalities were reached by UNICEF. 

### 10 municipalities with the highest numbers of beneficiaries are: 

```{r}

# output table
all_mun %>% slice(1: 10) %>% pander()

# sum of top ten
top_mun_sum <- all_mun %>% 
  slice(1:10) %>% summarise(sum = sum(beneficiarios))

all_mun_sum <- all_mun %>% 
  summarise(sum = sum(beneficiarios))

```

> Together, these 10 municipalities form `r round(top_mun_sum / all_mun_sum * 100)`% of the `r format(sum(all_mun$beneficiarios), big.mark = ",")` beneficiaries reached. 



## Reports about Partners

### Summary by Partner

```{r}
act_ben <- act_ben %>% 
mutate(organizacion_implementadora = 
           str_replace_all(organizacion_implementadora, 
                           "UNICEF - Fondo de las Naciones Unidas para la Infancia",
                           "UNICEF"))

act_ben %>% 
  filter(actividad_codigo != "CA1.05") %>% # filter out promocion de mensajes claves
  group_by(organizacion_implementadora) %>% 
  summarise(beneficiarios = sum(beneficiarios)) %>%
  ggplot(aes(x = fct_reorder(organizacion_implementadora, beneficiarios, .desc = TRUE), 
             y = beneficiarios)) +
  geom_col(fill = "cornflowerblue") +
  geom_text(aes(label = scales::comma(beneficiarios)), 
            vjust = -0.25, size = 3) +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 400000)) +
  xlab("") + ylab("Beneficiarios") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Partners' progress over time

```{r}
act_ben %>% 
  filter(actividad_codigo != "CA1.05") %>% # filter out promocion de mensajes claves
  mutate(mes_solo = as.Date(mes_solo)) %>% 
  group_by(organizacion_implementadora, mes_solo) %>% 
  summarise(cumulative = sum(beneficiarios)) %>% 
  mutate(cumulative = cumsum(cumulative)) %>% 
  ggplot(aes(x = mes_solo, y = cumulative, colour = organizacion_implementadora)) +
  geom_line() +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  scale_y_continuous(labels = unit_format(unit = "K", scale = 1e-3, sep = ""), 
                     limits = c(0, 410000)) +
  xlab("") + ylab("Beneficiarios") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 8))
  
```

## Summary table about partners' achievements

```{r}
act_ben %>% 
  filter(actividad_codigo != "CA1.05") %>% # do you want to keep it in?
  mutate(sex_ben = ifelse(str_detect(desagregacion, "^m"), "male",
                          ifelse(str_detect(desagregacion, "^f"), "female", "no_esp"))) %>% 
  mutate(actividad = actividad_desc) %>% 
  group_by(organizacion_implementadora) %>% 
  summarise(total = sum(beneficiarios, na.rm = TRUE),
            male = sum((beneficiarios[sex_ben == "male"])),
            female = sum((beneficiarios[sex_ben == "female"])),
            sex_ratio = round((male/female), digits = 2)) %>% 
  mutate(percent_total = round((total / sum(total) * 100), digits = 2)) %>% 
  relocate(percent_total, .after = total) %>% 
  arrange(desc(total)) %>% 
  pander(big.mark = ",", style = "rmarkdown")
```

## Maps

```{r}
# quiet = TRUE is very important here
pcode2_shape <- st_read("C:/Users/Sean Ng/Documents/R/5W/vnz_adm2_shapefiles/ven_admbnda_adm2_20180502.shp", quiet = TRUE)

# To explain, 
mun_ben_plot <- pcode2_shape %>% 
  mutate(pcode2 = ADM2_PCODE) %>% 
  left_join(., all_mun %>% select(municipio, pcode2, beneficiarios)) %>% 
  st_as_sf() %>% 
  ggplot(aes(fill = beneficiarios)) +
  geom_sf(size = 0.005) +
  theme_void() +
  ggtitle("Number of beneficiaries reached by municipality") +
  scale_fill_gradient(trans = trans_reverser('log10'), labels = comma, na.value = "gray90") +
   theme(legend.key.size = unit(0.3, "cm"),
        legend.position = c(0.9, 0.1),
        legend.title = element_blank(), 
        plot.title = element_text(size = 12))
  

mun_pop_plot <- cen_ref %>% 
  select(pcode2, ham_2019_xx_poblacion_pobre_por_parroquia) %>% 
  group_by(pcode2) %>% 
  summarise(poor_pop = sum(ham_2019_xx_poblacion_pobre_por_parroquia)) %>% 
  right_join(., all_mun %>% select(municipio, pcode2, beneficiarios)) %>%
  mutate(percent_reached = beneficiarios/poor_pop*100) %>% 
  select(municipio, pcode2, percent_reached) %>% 
  right_join(pcode2_shape %>% mutate(pcode2 = ADM2_PCODE)) %>% 
  st_as_sf() %>% 
  ggplot(aes(fill = percent_reached)) +
  geom_sf(size = 0.005) +
  theme_void() +
  ggtitle("Percentage of poor persons reached by municipality") +
  scale_fill_gradient(labels = comma, trans = "reverse", na.value = "gray90")+
  theme(legend.key.size = unit(0.3, "cm"),
        legend.position = c(0.9, 0.1),
        legend.title = element_blank(), 
        plot.title = element_text(size = 12))

# this uses patchwork to put both plots side by side             
mun_ben_plot + mun_pop_plot + plot_layout(ncol = 2)

```