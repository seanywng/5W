<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sean Ng">
<meta name="dcterms.date" content="2024-01-12">

<title>Cleaning Education 5W data from Venezuela</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="cleaning_5ws_english_files/libs/clipboard/clipboard.min.js"></script>
<script src="cleaning_5ws_english_files/libs/quarto-html/quarto.js"></script>
<script src="cleaning_5ws_english_files/libs/quarto-html/popper.min.js"></script>
<script src="cleaning_5ws_english_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="cleaning_5ws_english_files/libs/quarto-html/anchor.min.js"></script>
<link href="cleaning_5ws_english_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="cleaning_5ws_english_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="cleaning_5ws_english_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="cleaning_5ws_english_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="cleaning_5ws_english_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="cleaning_5ws_english_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="cleaning_5ws_english_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">



</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a.-cleaning-the-5w-data" id="toc-a.-cleaning-the-5w-data" class="nav-link active" data-scroll-target="#a.-cleaning-the-5w-data">A. Cleaning the 5W data</a>
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#reading-in-the-data" id="toc-reading-in-the-data" class="nav-link" data-scroll-target="#reading-in-the-data">1. Reading in the data</a></li>
  <li><a href="#string-manipulation-and-recoding" id="toc-string-manipulation-and-recoding" class="nav-link" data-scroll-target="#string-manipulation-and-recoding">2. String Manipulation and Recoding</a>
  <ul class="collapse">
  <li><a href="#a.-recoding-erroneous-data" id="toc-a.-recoding-erroneous-data" class="nav-link" data-scroll-target="#a.-recoding-erroneous-data">2a. Recoding erroneous data</a></li>
  <li><a href="#b.-removing-accents-and-standardising-case" id="toc-b.-removing-accents-and-standardising-case" class="nav-link" data-scroll-target="#b.-removing-accents-and-standardising-case">2b. Removing accents and standardising case</a></li>
  <li><a href="#c.-one-function-for-reading-and-cleaning" id="toc-c.-one-function-for-reading-and-cleaning" class="nav-link" data-scroll-target="#c.-one-function-for-reading-and-cleaning">2c. One function for reading and cleaning</a></li>
  </ul></li>
  <li><a href="#cleaning-locations" id="toc-cleaning-locations" class="nav-link" data-scroll-target="#cleaning-locations">3. Cleaning locations</a>
  <ul class="collapse">
  <li><a href="#b.-splitting-the-dataset-into-clean-and-dirty" id="toc-b.-splitting-the-dataset-into-clean-and-dirty" class="nav-link" data-scroll-target="#b.-splitting-the-dataset-into-clean-and-dirty">3b. Splitting the dataset into clean and dirty</a></li>
  <li><a href="#c.-fill-in-missing-values-with-coalesce" id="toc-c.-fill-in-missing-values-with-coalesce" class="nav-link" data-scroll-target="#c.-fill-in-missing-values-with-coalesce">3c. Fill in missing values with <code>coalesce()</code></a></li>
  <li><a href="#d.-error-checking-the-join" id="toc-d.-error-checking-the-join" class="nav-link" data-scroll-target="#d.-error-checking-the-join">3d. Error checking the join</a></li>
  </ul></li>
  <li><a href="#beneficiary-disaggregation" id="toc-beneficiary-disaggregation" class="nav-link" data-scroll-target="#beneficiary-disaggregation">4. Beneficiary disaggregation</a></li>
  <li><a href="#outputs" id="toc-outputs" class="nav-link" data-scroll-target="#outputs">5. Outputs</a>
  <ul class="collapse">
  <li><a href="#a.-cleaned-wide-version" id="toc-a.-cleaned-wide-version" class="nav-link" data-scroll-target="#a.-cleaned-wide-version">5a. Cleaned wide version</a></li>
  <li><a href="#b.-unique-beneficiaries" id="toc-b.-unique-beneficiaries" class="nav-link" data-scroll-target="#b.-unique-beneficiaries">5b. Unique beneficiaries</a></li>
  <li><a href="#c.-beneficiaries-by-activity" id="toc-c.-beneficiaries-by-activity" class="nav-link" data-scroll-target="#c.-beneficiaries-by-activity">5c. Beneficiaries by activity</a></li>
  <li><a href="#d.-comparing-unique_ben-activity_ben-and-difference" id="toc-d.-comparing-unique_ben-activity_ben-and-difference" class="nav-link" data-scroll-target="#d.-comparing-unique_ben-activity_ben-and-difference">5d. Comparing <code>unique_ben</code>, <code>activity_ben</code> and difference</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Cleaning Education 5W data from Venezuela</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Updated 7 May 2024</p>
</div>



<div class="quarto-title-meta column-page-right">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sean Ng </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="a.-cleaning-the-5w-data" class="level1">
<h1>A. Cleaning the 5W data</h1>
<p><br></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This page documents they typical cleaning process I would employ for programmatically handling data cleaning and reporting of 5W data in R. In this first section, we will be going through a sample cleaning script; the next section will deal with report generation.</p>
<p>We will be using data from the Education Cluster in Venezuela with partner names recoded. For another example of a cleaning script for 5Ws from Kenya, please see <a href="https://github.com/kenya-eie-wg/eie_wg_5ws/blob/main/5Ws_cleaning_script.Rmd">here</a>.</p>
<p>Click <a href="https://seanywng.github.io/5W/reporting_5ws_english">here</a> to jump to the next section on 5Ws reporting.</p>
<p><br><br><br></p>
</section>
<section id="reading-in-the-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-in-the-data">1. Reading in the data</h2>
<p>As in typical, the data is in separate files, one from each partner and one for UNICEF itself, the cluster lead:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "SOCIO 1.xlsx"                                               
 [2] "SOCIO 10.xlsx"                                              
 [3] "SOCIO 2.xlsx"                                               
 [4] "SOCIO 3.xlsx"                                               
 [5] "SOCIO 4.xlsx"                                               
 [6] "SOCIO 5.xlsx"                                               
 [7] "SOCIO 6.xlsx"                                               
 [8] "SOCIO 7.xlsx"                                               
 [9] "SOCIO 8.xlsx"                                               
[10] "SOCIO 9.xlsx"                                               
[11] "UNICEF - Fondo de las Naciones Unidas para la Infancia.xlsx"</code></pre>
</div>
</div>
<p>We start with a bit of organisation by setting the column types and names for the data that we are reading in. Even if we were working in Spanish, we would still need to clean up the column names as they can be overly long or can contain instructions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># specifying column types </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df_col_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"date"</span>, <span class="st">"text"</span>, <span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"text"</span>,<span class="st">"text"</span>,<span class="st">"text"</span>, <span class="st">"numeric"</span>, <span class="st">"text"</span>, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"date"</span>, <span class="st">"date"</span>, <span class="st">"text"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"numeric"</span>, <span class="st">"numeric"</span>, <span class="st">"numeric"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>df_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"date_reported"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>               <span class="st">"month_reported"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>               <span class="st">"project_code"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>               <span class="st">"project_name"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>               <span class="st">"lead_organisation"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">"implementing_partner"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>               <span class="st">"state"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>               <span class="st">"pcode1"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>               <span class="st">"municipality"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>               <span class="st">"pcode2"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>               <span class="st">"parrish"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>               <span class="st">"pcode3"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>               <span class="st">"location"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>               <span class="st">"latitude"</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>               <span class="st">"longitude"</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>               <span class="st">"activity_full"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>               <span class="st">"activity_code"</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>               <span class="st">"activity_description"</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>               <span class="st">"activity_code_descrption"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>               <span class="st">"activity_covid"</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>               <span class="st">"unit"</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>               <span class="st">"quantity_mensual"</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>               <span class="st">"recurrent_beneficiaries"</span>,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>               <span class="st">"start_date"</span>,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>               <span class="st">"end_date"</span>,</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>               <span class="st">"activity_status"</span>,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>               <span class="st">"total_beneficiaries"</span>,</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>               <span class="st">"percent_indigenous"</span>,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>               <span class="st">"percent_pwd"</span>,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>               <span class="st">"m_0_3"</span>,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>               <span class="st">"m_3_6"</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>               <span class="st">"m_7_12"</span>,</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>               <span class="st">"m_12_17"</span>,</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>               <span class="st">"m_18_19"</span>,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>               <span class="st">"f_0_3"</span>,</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>               <span class="st">"f_3_6"</span>,</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>               <span class="st">"f_7_12"</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>               <span class="st">"f_12_17"</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>               <span class="st">"f_18_19"</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>               <span class="st">"f_19_and_older"</span>,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>               <span class="st">"m_19_and_older"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will write a function to read in the data and then consolidate all the files. The loop at the end combines all the cleaned files together into one dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for reading in 5Ws files</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>read_5ws <span class="ot">&lt;-</span> <span class="cf">function</span>(file){</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_excel</span>(file, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">sheet =</span> <span class="dv">1</span>, </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">col_types =</span> df_col_types)<span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>()<span class="sc">|&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(df_names) <span class="sc">|&gt;</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cleaning the date</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">month_reported =</span> <span class="fu">ceiling_date</span>(month_reported, <span class="st">"month"</span>) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Path to 4Ws</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the folder where the 4Ws from the current round are stored. </span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Because we are using the `here` package, we can use the dot notation, </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># which greatly aids reproducibility</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>path_5ws <span class="ot">&lt;-</span> <span class="st">"./data"</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Change the folder to the correct one</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># The files will be read from here </span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> path_5ws, </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                        <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.xlsx$"</span>, </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">full.names =</span> <span class="cn">TRUE</span>) </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtering out open files?</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> file_list[<span class="sc">!</span><span class="fu">str_detect</span>(file_list, <span class="st">"</span><span class="sc">\\</span><span class="st">~"</span>)]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># For loop to work, let's initialise an empty data frame</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(file_list)) {</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  df_raw_i <span class="ot">&lt;-</span> <span class="fu">read_5ws</span>(file_list[i])</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  df_raw <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_raw, df_raw_i)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Let us take a look at the consolidated file. From the output below, we can see that there are 12,054 rows and 41 columns in the dataset. The output below shows column names, column data types (in the angle brackets) and a preview of the data in each column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 12,054
Columns: 41
$ date_reported            &lt;dttm&gt; 2020-12-01, 2020-12-01, 2020-12-01, 2020-12-…
$ month_reported           &lt;dttm&gt; 2020-11-30, 2020-11-30, 2020-11-30, 2020-11-…
$ project_code             &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ project_name             &lt;chr&gt; "Educación para todas y todos: continuidad ed…
$ lead_organisation        &lt;chr&gt; "UNICEF - Fondo de las Naciones Unidas para l…
$ implementing_partner     &lt;chr&gt; "SOCIO 1", "SOCIO 1", "SOCIO 1", "SOCIO 1", "…
$ state                    &lt;chr&gt; "BOLÍVAR", "BOLÍVAR", "BOLÍVAR", "BOLÍVAR", "…
$ pcode1                   &lt;chr&gt; "VE07", "VE07", "VE07", "VE07", "VE07", "VE07…
$ municipality             &lt;chr&gt; "CARONÍ", "CARONÍ", "CARONÍ", "CARONÍ", "CARO…
$ pcode2                   &lt;chr&gt; "VE0701", "VE0701", "VE0701", "VE0701", "VE07…
$ parrish                  &lt;chr&gt; "ONCE DE ABRIL", "ONCE DE ABRIL", "VISTA AL S…
$ pcode3                   &lt;chr&gt; "VE070104", "VE070104", "VE070108", "VE070108…
$ location                 &lt;chr&gt; "U.E.C. María Teresa Del Toro", "E.B.C FE Y A…
$ latitude                 &lt;dbl&gt; 8.383985, 8.377784, 8.355650, 8.343790, 8.331…
$ longitude                &lt;dbl&gt; -62.61942, -62.62054, -62.61467, -62.60385, -…
$ activity_full            &lt;chr&gt; "CLEDU/CA2.08: Educación a distancia", "CLEDU…
$ activity_code            &lt;chr&gt; "CA2.08", "CA2.08", "CA2.08", "CA2.08", "CA2.…
$ activity_description     &lt;chr&gt; "Educación a distancia", "Educación a distanc…
$ activity_code_descrption &lt;chr&gt; "CA2.08: Educación a distancia", "CA2.08: Edu…
$ activity_covid           &lt;chr&gt; "Sí", "Sí", "Sí", "Sí", "Sí", "Sí", "Sí", "Sí…
$ unit                     &lt;chr&gt; "#Personas", "#Personas", "#Personas", "#Pers…
$ quantity_mensual         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ recurrent_beneficiaries  &lt;chr&gt; "No", "No", "No", "No", "No", "No", "No", "No…
$ start_date               &lt;dttm&gt; 2020-11-02, 2020-11-02, 2020-11-02, 2020-11-…
$ end_date                 &lt;dttm&gt; 2020-11-30, 2020-11-30, 2020-11-30, 2020-11-…
$ activity_status          &lt;chr&gt; "En ejecución", "En ejecución", "En ejecución…
$ total_beneficiaries      &lt;dbl&gt; 203, 998, 962, 921, 180, 1178, 806, 913, 688,…
$ percent_indigenous       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ percent_pwd              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ m_0_3                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ m_3_6                    &lt;dbl&gt; 17, NA, 49, 44, 82, 113, 37, 43, 125, NA, NA,…
$ m_7_12                   &lt;dbl&gt; 83, 354, 289, 175, NA, 330, 198, 258, 265, 17…
$ m_12_17                  &lt;dbl&gt; NA, 169, 169, 231, NA, 150, 154, 174, NA, NA,…
$ m_18_19                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ f_0_3                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ f_3_6                    &lt;dbl&gt; 26, NA, 48, 47, 98, 99, 26, 38, 99, NA, NA, 7…
$ f_7_12                   &lt;dbl&gt; 77, 324, 267, 175, NA, 311, 211, 244, 199, 17…
$ f_12_17                  &lt;dbl&gt; NA, 151, 140, 249, NA, 175, 180, 156, NA, NA,…
$ f_18_19                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ f_19_and_older           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ m_19_and_older           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</code></pre>
</div>
</div>
<p>Setting the column types seems to have paid off well, especially since we do not seem to need to clean the date-time data.</p>
<p><br><br></p>
</section>
<section id="string-manipulation-and-recoding" class="level2">
<h2 class="anchored" data-anchor-id="string-manipulation-and-recoding">2. String Manipulation and Recoding</h2>
<section id="a.-recoding-erroneous-data" class="level3">
<h3 class="anchored" data-anchor-id="a.-recoding-erroneous-data">2a. Recoding erroneous data</h3>
<p>Errors are part of the 5W process, really any data entry process. However, R makes it easy to programmatically recode these errors. Below are some examples of the range of responses from the <code>recurrent_beneficiaries</code> column, which indicates whether beneficiaries have been reached before.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Recurrent beneficiaries responses</caption>
<colgroup>
<col style="width: 6%">
<col style="width: 11%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">no</th>
<th style="text-align: center;">No</th>
<th style="text-align: center;">Si</th>
<th style="text-align: center;">sí</th>
<th style="text-align: center;">Sí</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: center;">4,937</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">6,408</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We will recode these as yes/no. We will do do something similar for other columns, such as this one:</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Activity status responses</caption>
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">En ejecucion</th>
<th style="text-align: center;">en ejecución</th>
<th style="text-align: center;">en Ejecución</th>
<th style="text-align: center;">En ejecución</th>
<th style="text-align: center;">En Ejecución</th>
<th style="text-align: center;">finalizada</th>
<th style="text-align: center;">Finalizada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">6,453</td>
<td style="text-align: center;">107</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3,257</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>To resolve this, we will just recode the erroneous data and recode it. We have also cleaned out some of the <code>NAs</code> from the <code>recurrent_beneficiaries</code> and <code>acitivity_covid</code> columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">recurrent_beneficiaries =</span> (<span class="fu">recode</span>(recurrent_beneficiaries, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span> <span class="ot">=</span> <span class="st">"no"</span>, <span class="st">"No"</span> <span class="ot">=</span> <span class="st">"no"</span>, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"Sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>)),  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">activity_covid =</span> <span class="fu">recode</span>(activity_covid, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span> <span class="ot">=</span> <span class="st">"no"</span>, <span class="st">"No"</span> <span class="ot">=</span> <span class="st">"no"</span>, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"Sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># recoding NAs</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">recurrent_beneficiaries =</span> <span class="st">"no"</span>, <span class="at">activity_covid =</span> <span class="st">"no"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">activity_status =</span> <span class="fu">str_replace_all</span>(activity_status, </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">c</span>(<span class="st">"En ejecucion"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>, </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"en ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"en Ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"En ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"En Ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"finalizada"</span> <span class="ot">=</span> <span class="st">"finalizada"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"Finalizada"</span> <span class="ot">=</span> <span class="st">"finalizada"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
<section id="b.-removing-accents-and-standardising-case" class="level3">
<h3 class="anchored" data-anchor-id="b.-removing-accents-and-standardising-case">2b. Removing accents and standardising case</h3>
<p>This dataset is from Venezuela and has numerous tildes and diacritical marks. However, their use amongst partners is not consistent. Although proper spelling in Spanish has diacritical marks, it is easiest to remove them all before working in code. Implementing partners also don’t really pay attention to this either and typically have submissions with a wide variety of spellings, especially for place names; we will also clean out the activity descriptions.</p>
<p>Let us first make a simple function to remove diacritical marks and force</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to remove accents</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stri_trans_general is from `stringi` and is typically used in </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># script-to-script conversions and transliterations </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.rdocumentation.org/packages/stringi/versions/1.8.3/topics/stri_trans_general</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>rm_accent <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">stri_trans_general</span>(x, <span class="st">"Latin-ASCII"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># removing accents</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and str_to_lower() since R is case-sensitive</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state    =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(state)), </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">municipality =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(municipality)),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">parrish =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(parrish)),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">location =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(location)),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">activity_description =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(activity_description)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
<section id="c.-one-function-for-reading-and-cleaning" class="level3">
<h3 class="anchored" data-anchor-id="c.-one-function-for-reading-and-cleaning">2c. One function for reading and cleaning</h3>
<p>We will now combine all this recoding into one function, organising our code better and improving readability. In dirtier datasets, sometimes partner names will need to be cleaned too (but that was done when this dataset was anonymised). To prevent data entry errors, we should just have been stricter about using dropdown tables.</p>
<p>In fact, let us put all these steps right before the reading and consolidation loop so that data is cleaned as it is read into the consolidated dataset. Let’s first amend the reading function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If you haven't run it yet</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>rm_accent <span class="ot">&lt;-</span> <span class="cf">function</span>(colns){</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  colns <span class="ot">&lt;-</span> <span class="fu">stri_trans_general</span>(colns, <span class="st">"Latin-ASCII"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>read_and_clean_5ws <span class="ot">&lt;-</span> <span class="cf">function</span>(file){</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_excel</span>(file, </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">sheet =</span> <span class="dv">1</span>, </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">col_types =</span> df_col_types)<span class="sc">|&gt;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>()<span class="sc">|&gt;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(df_names) <span class="sc">|&gt;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">recurrent_beneficiaries =</span> (<span class="fu">recode</span>(recurrent_beneficiaries, </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span> <span class="ot">=</span> <span class="st">"no"</span>, <span class="st">"No"</span> <span class="ot">=</span> <span class="st">"no"</span>, </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"Sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>)),  </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">activity_covid =</span> <span class="fu">recode</span>(activity_covid, </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span> <span class="ot">=</span> <span class="st">"no"</span>, <span class="st">"No"</span> <span class="ot">=</span> <span class="st">"no"</span>, </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"si"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>, <span class="st">"Sí"</span> <span class="ot">=</span> <span class="st">"yes"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># recoding NAs</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">recurrent_beneficiaries =</span> <span class="st">"no"</span>, <span class="at">activity_covid =</span> <span class="st">"no"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">activity_status =</span> <span class="fu">str_replace_all</span>(activity_status, </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                                             <span class="fu">c</span>(<span class="st">"En ejecucion"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>, </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"en ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"en Ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"En ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"En Ejecución"</span> <span class="ot">=</span> <span class="st">"ejecucion"</span>,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"finalizada"</span> <span class="ot">=</span> <span class="st">"finalizada"</span>,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"Finalizada"</span> <span class="ot">=</span> <span class="st">"finalizada"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state    =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(state)), </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">municipality =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(municipality)),</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">parrish =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(parrish)),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">location =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(location)),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">activity_description =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(activity_description))) <span class="sc">|&gt;</span> </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cleaning the date</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">month_reported =</span> <span class="fu">ceiling_date</span>(month_reported, <span class="st">"month"</span>) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>))</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>path_5ws <span class="ot">&lt;-</span> <span class="st">"./data"</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Change the folder to the correct one</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="co"># The files will be read from here </span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> path_5ws, </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>                        <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.xlsx$"</span>, </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>                        <span class="at">full.names =</span> <span class="cn">TRUE</span>) </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtering out open files?</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> file_list[<span class="sc">!</span><span class="fu">str_detect</span>(file_list, <span class="st">"</span><span class="sc">\\</span><span class="st">~"</span>)]</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-initialising the empty dataframe</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Let us repeat the loop, with the new reading and cleaning function</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(file_list)) {</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  df_raw_i <span class="ot">&lt;-</span> <span class="fu">read_and_clean_5ws</span>(file_list[i])</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>  df_raw <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_raw, df_raw_i)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
</section>
<section id="cleaning-locations" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-locations">3. Cleaning locations</h2>
<p>Now that we have a consolidated, semi-clean dataset, let us now clean geographic and location data.</p>
<p>We will first read in <code>locations.csv</code>. This file comes from the official gazette of administrative areas and is typically available on HDX. The <code>locations.csv</code> dataset also has schools and schools codes, in addition to state, municipality and parrish official names and pcodes, given that I was using it for the education cluster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>locations <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"locations.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using the rm_accent() function from earlier</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state  =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(estado)), <span class="co"># just to make sure </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">municipality =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(municipio)),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">parrish =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(parroquia)),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">location =</span> <span class="fu">rm_accent</span>(<span class="fu">str_to_lower</span>(ubicacion))) <span class="sc">|&gt;</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>estado, <span class="sc">-</span>municipio, <span class="sc">-</span>parroquia, <span class="sc">-</span>ubicacion)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will also use an anti-join to identify new project sites which we should add to the location database. We won’t be doing this in this exercise, but updating the project site database is important for verification, monitoring and accountability to affected populations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see if you need to update locations </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># new locations not in locations.csv will be caught by the anti-join()</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a> locations_add <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(state, pcode1, municipality, pcode2, parrish, pcode3, location,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>          latitude, longitude) <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">anti_join</span>(locations, <span class="at">by =</span> <span class="st">"location"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
<section id="b.-splitting-the-dataset-into-clean-and-dirty" class="level3">
<h3 class="anchored" data-anchor-id="b.-splitting-the-dataset-into-clean-and-dirty">3b. Splitting the dataset into clean and dirty</h3>
<p>Let us identify the incomplete locations. We can see from the output that there are 557 rows with missing geographic data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(state) <span class="sc">|</span> <span class="fu">is.na</span>(pcode1) <span class="sc">|</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(municipality) <span class="sc">|</span> <span class="fu">is.na</span>(pcode2) <span class="sc">|</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(parrish) <span class="sc">|</span> <span class="fu">is.na</span>(pcode3)) <span class="sc">|&gt;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 557</code></pre>
</div>
</div>
<p>We will split off these rows to be cleaned. We will combine it back together later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># splitting into two datasets, one clean one dirty. </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>locations_dirty <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(state) <span class="sc">|</span> <span class="fu">is.na</span>(pcode1) <span class="sc">|</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(municipality) <span class="sc">|</span> <span class="fu">is.na</span>(pcode2) <span class="sc">|</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(parrish) <span class="sc">|</span> <span class="fu">is.na</span>(pcode3))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>locations_clean <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span> </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(state) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(pcode1) <span class="sc">&amp;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(municipality) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(pcode2) <span class="sc">&amp;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(parrish) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(pcode3)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
<section id="c.-fill-in-missing-values-with-coalesce" class="level3">
<h3 class="anchored" data-anchor-id="c.-fill-in-missing-values-with-coalesce">3c. Fill in missing values with <code>coalesce()</code></h3>
<p>The <code>locations.csv</code> reference dataset is used to clean <code>locations_dirty</code> and rewrite it. The <code>distinct()</code> call at the end is to ensure that there are no duplicates. After which, we combine <code>locations_clean</code> and <code>locations_dirty</code> into <code>df_raw_locations</code>.</p>
<p><br></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filling in missing values</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>locations_dirty <span class="ot">&lt;-</span> locations_dirty <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(locations, <span class="at">by =</span> <span class="st">"location"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state    =</span> <span class="fu">coalesce</span>(state.x, state.y),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">pcode1    =</span> <span class="fu">coalesce</span>(pcode1.x, pcode1.y),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">municipality =</span> <span class="fu">coalesce</span>(municipality.x, municipality.y),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">pcode2    =</span> <span class="fu">coalesce</span>(pcode2.x, pcode2.y),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">parrish =</span> <span class="fu">coalesce</span>(parrish.x, parrish.y),</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">pcode3    =</span> <span class="fu">coalesce</span>(pcode3.x, pcode3.y)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>state.x, <span class="sc">-</span>state.y, <span class="sc">-</span>pcode1.x, <span class="sc">-</span>pcode1.y,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>municipality.x, <span class="sc">-</span>municipality.y, <span class="sc">-</span>pcode2.x, <span class="sc">-</span>pcode2.y,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>parrish.x, <span class="sc">-</span>parrish.y, <span class="sc">-</span>pcode3.x, <span class="sc">-</span>pcode3.y) <span class="sc">%&gt;%</span> </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="co"># removing duplicate rows from the join </span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># bind_rows() does not care about column sequence </span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># but put adm_clean first so that the original order is preserved</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>df_raw_locations <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(locations_clean, locations_dirty)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
<section id="d.-error-checking-the-join" class="level3">
<h3 class="anchored" data-anchor-id="d.-error-checking-the-join">3d. Error checking the join</h3>
<p>Printing out the sum of the <code>total_beneficiaries</code> and the number of rows in <code>df_raw</code>(original dataset) and <code>df_raw_locations</code>(updated, with the locations cleaned).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># error checking</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="fu">sum</span>(df_raw<span class="sc">$</span>total_beneficiaries, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(df_raw_locations<span class="sc">$</span>total_beneficiaries, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nrow</span>(df_raw),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nrow</span>(df_raw_locations))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         [,1]
[1,] 28965878
[2,] 28965878
[3,]    12054
[4,]    12054</code></pre>
</div>
</div>
<p>Everything seems in order, and we have not duplicated or dropped any rows from the original dataset.</p>
<p><br><br><br></p>
</section>
</section>
<section id="beneficiary-disaggregation" class="level2">
<h2 class="anchored" data-anchor-id="beneficiary-disaggregation">4. Beneficiary disaggregation</h2>
<p>Let us next check on the beneficiary disaggregations by comparing the sum of all disaggregated beneficiaries against the reported total. We will mutate two new columns: <code>total_disagg_ben</code>, which is the sum of all sex and age-disaggregated beneficiaries and <code>no_disagg_ben</code> for beneficiaries reported without sex and age information. Depending on reporting standards of each cluster, we will have different uses for the disaggregated and non-disaggregated numbers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mutating bencheck and unspecified beneficiaries columns </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>df_raw_locations <span class="ot">&lt;-</span> df_raw_locations <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_disagg_ben =</span> <span class="fu">select</span>(., m_0_3<span class="sc">:</span>m_19_and_older) <span class="sc">%&gt;%</span>  <span class="fu">rowSums</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">no_disagg_ben =</span> <span class="fu">round</span>(total_beneficiaries) <span class="sc">-</span> <span class="fu">round</span>(total_disagg_ben)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us print the rows where the sum of disaggregated beneficiaries (<code>total_disagg_ben</code>) does not match the totals reported in the <code>total_beneficiaries</code> column, so that we can return to the relevant parties for follow up.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-bordered table-sm table-striped small" data-quarto-postprocess="true">
<caption>Undisaggregated beneficiaries</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">implementing_partner</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">activity_description</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">total_disagg_ben</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">total_beneficiaries</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">no_disagg_ben</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SOCIO 2</td>
<td style="text-align: left;">promocion mensajes claves para la comunidad escolar</td>
<td style="text-align: left;">u.e.c. divina pastora (catedral)</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">244</td>
<td style="text-align: right;">244</td>
</tr>
<tr class="even">
<td style="text-align: left;">SOCIO 4</td>
<td style="text-align: left;">iniciativas para reinsercion educativa de nna fuera de la escuela</td>
<td style="text-align: left;">u.e. san jose de cotiza</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SOCIO 6</td>
<td style="text-align: left;">formacion docente y otro personal educativo</td>
<td style="text-align: left;">ministerio del poder popular para la educacion</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">398</td>
</tr>
<tr class="even">
<td style="text-align: left;">SOCIO 6</td>
<td style="text-align: left;">formacion docente y otro personal educativo</td>
<td style="text-align: left;">cluster de educacion</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">146</td>
<td style="text-align: right;">146</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p><br></p>
<p>In this scenario, we would have returned to these three partners and asked for corrections.</p>
<p><br><br><br></p>
</section>
<section id="outputs" class="level2">
<h2 class="anchored" data-anchor-id="outputs">5. Outputs</h2>
<section id="a.-cleaned-wide-version" class="level3">
<h3 class="anchored" data-anchor-id="a.-cleaned-wide-version">5a. Cleaned wide version</h3>
<p>We can now share a clean version of the wide file with OCHA, they will generally prefer a wide table, in the same shape as the 5W form:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># turn on eval if you want the file</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(df_raw_locations, <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%y%m%d_%H%M_"</span>), <span class="st">"5W_wide.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
<section id="b.-unique-beneficiaries" class="level3">
<h3 class="anchored" data-anchor-id="b.-unique-beneficiaries">5b. Unique beneficiaries</h3>
<p>This section pivots the dataset longer into a tidy format – normal 5W templates tend to “wide”, with the totals and beneficiary disaggregations all in one row. We use a long format to make things easier for plotting and analysis.</p>
<p>We will also create the dataset <code>unique_ben</code> to aid in our estimations of the actual reach of the programme. This is distinct from the concept of a beneficiary frequency, which is one person reached by one activity and does not account for double counting.</p>
<p>Unique beneficiaries are the individuals who have been reached by at least one programme activity. Frequencies are important for budgetary reasons and to show the full scale of the programme. Unique beneficiaries show a more accurate picture of the programme’s footprint and are very useful for coordinating activities with other clusters.</p>
<p>The gold standard for avoiding double counting is the deployment of a beneficiary database. However, most agencies are not able to do this. In lieu of that, to avoid double counting and estimate the number of unique beneficiaries, we will only add the highest number of beneficiaries reached at each project site (location).</p>
<p>At this point, we will also filter out the activity CA1.05, which the promotion of key messages for the education community, specifically, we will filter out all activities where the location is “radio” or “fm station”. Mass messaging activities do not typically count towards beneficiary totals as they are quite light-touch, especially in comparison to education kits, school feeding or work with out-of-school children. If need be, we can always analyse the radio messaging activity on its own.</p>
<p>Ideally, we would codify all this by developing indicator guidance for the cluster, though it did take a few years for the office to systematise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pivoting longer and creating new dataframe</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>unique_ben <span class="ot">&lt;-</span> df_raw_locations <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(location, <span class="st">"radio|fm"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_disagg_ben) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(m_0_3<span class="sc">:</span>no_disagg_ben, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"disaggregation"</span>, <span class="at">values_to =</span> <span class="st">"beneficiaries"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(recurrent_beneficiaries <span class="sc">==</span> <span class="st">"no"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(beneficiaries <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># empty cells are 0 in the 5W table</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location, disaggregation)<span class="sc">|&gt;</span> </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(beneficiaries)) <span class="sc">|&gt;</span>  </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span>  </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(month_reported, state, pcode1, municipality, pcode2,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>       parrish, pcode3, location, latitude, longitude, </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>       disaggregation, beneficiaries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># writing csv of unique_ben with datestamp</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># turn on eval if you want the file </span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(unique_ben, <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%y%m%d_%H%M_"</span>), <span class="st">"unique_ben.csv"</span>))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Without date stamp</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(unique_ben, <span class="fu">paste0</span>(<span class="st">"unique_ben.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
<section id="c.-beneficiaries-by-activity" class="level3">
<h3 class="anchored" data-anchor-id="c.-beneficiaries-by-activity">5c. Beneficiaries by activity</h3>
<p>Let us also make the dataset <code>activity_ben</code> for activity-wise analysis. As with <code>unique_ben</code>, recurrent beneficiaries have been filtered out. Similar to <code>unique_ben</code>, this dataset has also been pivoted longer into a tidy format.</p>
<p>Please note that there is double counting in this dataset as beneficiaries might have been reached by more than one activity. For geographic analysis, please use <code>unique_ben</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the dataset for beneficiaries</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>activity_ben <span class="ot">&lt;-</span> df_raw_locations <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(location, <span class="st">"radio|fm"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_disagg_ben) <span class="sc">|&gt;</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(m_0_3<span class="sc">:</span>no_disagg_ben, </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"disaggregation"</span>, <span class="at">values_to =</span> <span class="st">"beneficiaries"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(recurrent_beneficiaries <span class="sc">==</span> <span class="st">"no"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(beneficiaries <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># empty cells are 0 in the 5W table</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(month_reported, project_name, implementing_partner, </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>         state, pcode1, municipality, pcode2, </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>         parrish, pcode3, location, latitude, longitude, </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>         activity_code, activity_description, activity_covid,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>         disaggregation, beneficiaries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># writing csv activity_ben with datestamp</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># turn on eval if you want the file </span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(activity_ben, <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%y%m%d_%H%M_"</span>), <span class="st">"activity_ben.csv"</span>))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Without date stamp</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(activity_ben, <span class="fu">paste0</span>(<span class="st">"activity_ben.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
</section>
<section id="d.-comparing-unique_ben-activity_ben-and-difference" class="level3">
<h3 class="anchored" data-anchor-id="d.-comparing-unique_ben-activity_ben-and-difference">5d. Comparing <code>unique_ben</code>, <code>activity_ben</code> and difference</h3>
<p>Printed below are the numbers of unique beneficiaries, beneficiary frequencies and the difference between the two figures.</p>
<p><br></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,]  728408.4
[2,] 1071144.0
[3,] -342735.6</code></pre>
</div>
</div>
<p><br></p>
<p><a href="https://seanywng.github.io/5W/reporting_5ws_english">Click through</a> to the next part, where will go through 5W reporting and make use the cleaned datasets.</p>
<!-- -->

</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb25" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Cleaning Education 5W data from Venezuela"</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Sean Ng"</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "12 January 2024"</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Updated 7 May 2024"</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 4</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">    page-layout: full</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="fu"># A. Cleaning the 5W data</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 9.5)</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(lubridate)</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(stringr)</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(stringi)</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="in">library(pander)</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="in">library(forcats)</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(janitor)</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(readxl)</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggmap)</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggforce)</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggthemes)</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="in">library(plotly)</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="in">library(DT)</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(tinytex)</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(writexl)</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="in"># tables all in one row</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="in">panderOptions('table.split.table', Inf)</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="in"># thousands separator</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a><span class="in">panderOptions("big.mark", ",")</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(theme_light())</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="in"># Disabling scientific notation</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="in">options(scipen = 100)</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="in"># This should just be a standard R function</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="in">`%out%` &lt;- Negate(`%in%`)</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, echo = FALSE}</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="in"># Splitting the database</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a><span class="in"># Ignore this section</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a><span class="in">db_raw &lt;- read_excel("database activities 5W.xlsx", </span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a><span class="in">                    sheet = "data", </span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a><span class="in">                    skip = 1, </span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a><span class="in">                    col_types = df_col_types)  |&gt;</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(-c(1))</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a><span class="in">split(db_raw, db_raw$`Organización implementadora`)|&gt; </span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a><span class="in"> iwalk(~write_xlsx(.x, path = paste0("./data/", .y, ".xlsx")))</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>This page documents they typical cleaning process I would employ for programmatically handling data cleaning and reporting of 5W data in R. In this first section, we will be going through a sample cleaning script; the next section will deal with report generation. </span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>We will be using data from the Education Cluster in Venezuela with partner names recoded. For another example of a cleaning script for 5Ws from Kenya, please see <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/kenya-eie-wg/eie_wg_5ws/blob/main/5Ws_cleaning_script.Rmd)</span>.</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>Click <span class="co">[</span><span class="ot">here</span><span class="co">](https://seanywng.github.io/5W/reporting_5ws_english)</span> to jump to the next section on 5Ws reporting. </span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. Reading in the data</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>As in typical, the data is in separate files, one from each partner and one for UNICEF itself, the cluster lead:  </span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"./data"</span>)</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>We start with a bit of organisation by setting the column types and names for the data that we are reading in. Even if we were working in Spanish, we would still need to clean up the column names as they can be overly long or can contain instructions. </span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a><span class="in">```{r reading-in-xlsx, echo=TRUE}</span></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a><span class="in"># specifying column types </span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a><span class="in">df_col_types &lt;- c("date", "date", "text", "text","text","text",</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a><span class="in">                   "text","text","text","text","text","text","text",</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a><span class="in">                   "numeric", "numeric", "text","text","text",</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a><span class="in">                   "text","text","text", "numeric", "text", </span></span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a><span class="in">                   "date", "date", "text",</span></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a><span class="in">                   "numeric", "numeric", "numeric", "numeric",</span></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a><span class="in">                   "numeric", "numeric", "numeric", "numeric",</span></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a><span class="in">                   "numeric", "numeric", "numeric", "numeric",</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a><span class="in">                   "numeric", "numeric", "numeric")</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a><span class="in">df_names &lt;- c("date_reported",</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a><span class="in">               "month_reported",</span></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a><span class="in">               "project_code",</span></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a><span class="in">               "project_name",</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a><span class="in">               "lead_organisation",</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a><span class="in">               "implementing_partner",</span></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a><span class="in">               "state",</span></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a><span class="in">               "pcode1",</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a><span class="in">               "municipality",</span></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a><span class="in">               "pcode2",</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a><span class="in">               "parrish",</span></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a><span class="in">               "pcode3",</span></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a><span class="in">               "location",</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a><span class="in">               "latitude",</span></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a><span class="in">               "longitude",</span></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a><span class="in">               "activity_full",</span></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a><span class="in">               "activity_code",</span></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a><span class="in">               "activity_description",</span></span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a><span class="in">               "activity_code_descrption",</span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a><span class="in">               "activity_covid",</span></span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a><span class="in">               "unit",</span></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a><span class="in">               "quantity_mensual",</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a><span class="in">               "recurrent_beneficiaries",</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a><span class="in">               "start_date",</span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a><span class="in">               "end_date",</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a><span class="in">               "activity_status",</span></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a><span class="in">               "total_beneficiaries",</span></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a><span class="in">               "percent_indigenous",</span></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a><span class="in">               "percent_pwd",</span></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a><span class="in">               "m_0_3",</span></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a><span class="in">               "m_3_6",</span></span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a><span class="in">               "m_7_12",</span></span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a><span class="in">               "m_12_17",</span></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a><span class="in">               "m_18_19",</span></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a><span class="in">               "f_0_3",</span></span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a><span class="in">               "f_3_6",</span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a><span class="in">               "f_7_12",</span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a><span class="in">               "f_12_17",</span></span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a><span class="in">               "f_18_19",</span></span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a><span class="in">               "f_19_and_older",</span></span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a><span class="in">               "m_19_and_older")</span></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>Now we will write a function to read in the data and then consolidate all the files. The loop at the end combines all the cleaned files together into one dataframe.  </span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning = FALSE, echo=TRUE}</span></span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a><span class="in"># Function for reading in 5Ws files</span></span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a><span class="in">read_5ws &lt;- function(file){</span></span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a><span class="in">  read_excel(file, </span></span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a><span class="in">             sheet = 1, </span></span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a><span class="in">             col_types = df_col_types)|&gt;</span></span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a><span class="in">    janitor::clean_names()|&gt;</span></span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a><span class="in">    setNames(df_names) |&gt; </span></span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a><span class="in">    # Cleaning the date</span></span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(month_reported = ceiling_date(month_reported, "month") - days(1))</span></span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a><span class="in">## Path to 4Ws</span></span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a><span class="in"># This is the folder where the 4Ws from the current round are stored. </span></span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a><span class="in"># Because we are using the `here` package, we can use the dot notation, </span></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a><span class="in"># which greatly aids reproducibility</span></span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a><span class="in">path_5ws &lt;- "./data"</span></span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a><span class="in"># Change the folder to the correct one</span></span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a><span class="in"># The files will be read from here </span></span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a><span class="in">file_list &lt;- list.files(path = path_5ws, </span></span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a><span class="in">                        recursive = TRUE, </span></span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a><span class="in">                        pattern = "\\.xlsx$", </span></span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a><span class="in">                        full.names = TRUE) </span></span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a><span class="in"># Filtering out open files?</span></span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a><span class="in">file_list &lt;- file_list[!str_detect(file_list, "\\~")]</span></span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a><span class="in"># For loop to work, let's initialise an empty data frame</span></span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw &lt;- data.frame()</span></span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a><span class="in"># Loop</span></span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:length(file_list)) {</span></span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a><span class="in">  df_raw_i &lt;- read_5ws(file_list[i])</span></span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a><span class="in">  df_raw &lt;- rbind(df_raw, df_raw_i)</span></span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a>Let us take a look at the consolidated file. From the output below, we can see that there are <span class="in">`r format(df_raw |&gt; nrow(), big.mark = ",")`</span> rows and <span class="in">`r format(df_raw |&gt; ncol(), big.mark = ",")`</span> columns in the dataset. The output below shows column names, column data types (in the angle brackets) and a preview of the data in each column. </span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE}</span></span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw |&gt; </span></span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a><span class="in">  glimpse()</span></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a>Setting the column types seems to have paid off well, especially since we do not seem to need to clean the date-time data. </span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2. String Manipulation and Recoding </span></span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2a. Recoding erroneous data</span></span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a>Errors are part of the 5W process, really any data entry process. However, R makes it easy to programmatically recode these errors. Below are some examples of the range of responses from the <span class="in">`recurrent_beneficiaries`</span> column, which indicates whether beneficiaries have been reached before. </span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r recurrent-beneficiaries-table}</span></span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw$recurrent_beneficiaries |&gt; </span></span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a><span class="in">  table() |&gt; </span></span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a><span class="in">  pander(caption = "Recurrent beneficiaries responses")</span></span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-231"><a href="#cb25-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-232"><a href="#cb25-232" aria-hidden="true" tabindex="-1"></a>We will recode these as yes/no. We will do do something similar for other columns, such as this one: </span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r activity-status-table}</span></span>
<span id="cb25-236"><a href="#cb25-236" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw$activity_status |&gt; table() |&gt; pander(caption = "Activity status responses")</span></span>
<span id="cb25-237"><a href="#cb25-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-238"><a href="#cb25-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-239"><a href="#cb25-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-240"><a href="#cb25-240" aria-hidden="true" tabindex="-1"></a>To resolve this, we will just recode the erroneous data and recode it. We have also cleaned out some of the <span class="in">`NAs`</span> from the <span class="in">`recurrent_beneficiaries`</span> and <span class="in">`acitivity_covid`</span> columns: </span>
<span id="cb25-241"><a href="#cb25-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-242"><a href="#cb25-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-243"><a href="#cb25-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, eval=FALSE}</span></span>
<span id="cb25-244"><a href="#cb25-244" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw |&gt; </span></span>
<span id="cb25-245"><a href="#cb25-245" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(recurrent_beneficiaries = (recode(recurrent_beneficiaries, </span></span>
<span id="cb25-246"><a href="#cb25-246" aria-hidden="true" tabindex="-1"></a><span class="in">            "no" = "no", "No" = "no", </span></span>
<span id="cb25-247"><a href="#cb25-247" aria-hidden="true" tabindex="-1"></a><span class="in">            "Si" = "yes", "si" = "yes", "sí" = "yes", "Sí" = "yes")),  </span></span>
<span id="cb25-248"><a href="#cb25-248" aria-hidden="true" tabindex="-1"></a><span class="in">           activity_covid = recode(activity_covid, </span></span>
<span id="cb25-249"><a href="#cb25-249" aria-hidden="true" tabindex="-1"></a><span class="in">            "no" = "no", "No" = "no", </span></span>
<span id="cb25-250"><a href="#cb25-250" aria-hidden="true" tabindex="-1"></a><span class="in">            "Si" = "yes", "si" = "yes", "sí" = "yes", "Sí" = "yes")) |&gt;</span></span>
<span id="cb25-251"><a href="#cb25-251" aria-hidden="true" tabindex="-1"></a><span class="in">  # recoding NAs</span></span>
<span id="cb25-252"><a href="#cb25-252" aria-hidden="true" tabindex="-1"></a><span class="in">  replace_na(list(recurrent_beneficiaries = "no", activity_covid = "no")) |&gt;</span></span>
<span id="cb25-253"><a href="#cb25-253" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(activity_status = str_replace_all(activity_status, </span></span>
<span id="cb25-254"><a href="#cb25-254" aria-hidden="true" tabindex="-1"></a><span class="in">                                           c("En ejecucion" = "ejecucion", </span></span>
<span id="cb25-255"><a href="#cb25-255" aria-hidden="true" tabindex="-1"></a><span class="in">                                             "en ejecución" = "ejecucion",</span></span>
<span id="cb25-256"><a href="#cb25-256" aria-hidden="true" tabindex="-1"></a><span class="in">                                             "en Ejecución" = "ejecucion",</span></span>
<span id="cb25-257"><a href="#cb25-257" aria-hidden="true" tabindex="-1"></a><span class="in">                                             "En ejecución" = "ejecucion",</span></span>
<span id="cb25-258"><a href="#cb25-258" aria-hidden="true" tabindex="-1"></a><span class="in">                                             "En Ejecución" = "ejecucion",</span></span>
<span id="cb25-259"><a href="#cb25-259" aria-hidden="true" tabindex="-1"></a><span class="in">                                             "finalizada" = "finalizada",</span></span>
<span id="cb25-260"><a href="#cb25-260" aria-hidden="true" tabindex="-1"></a><span class="in">                                             "Finalizada" = "finalizada")))</span></span>
<span id="cb25-261"><a href="#cb25-261" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb25-262"><a href="#cb25-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-263"><a href="#cb25-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-264"><a href="#cb25-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-265"><a href="#cb25-265" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-266"><a href="#cb25-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-267"><a href="#cb25-267" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2b. Removing accents and standardising case</span></span>
<span id="cb25-268"><a href="#cb25-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-269"><a href="#cb25-269" aria-hidden="true" tabindex="-1"></a>This dataset is from Venezuela and has numerous tildes and diacritical marks. However, their use amongst partners is not consistent. Although proper spelling in Spanish has diacritical marks, it is easiest to remove them all before working in code. Implementing partners also don't really pay attention to this either and typically have submissions with a wide variety of spellings, especially for place names; we will also clean out the activity descriptions.  </span>
<span id="cb25-270"><a href="#cb25-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-271"><a href="#cb25-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-272"><a href="#cb25-272" aria-hidden="true" tabindex="-1"></a>Let us first make a simple function to remove diacritical marks and force </span>
<span id="cb25-273"><a href="#cb25-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-274"><a href="#cb25-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-275"><a href="#cb25-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove-accents, echo=TRUE}</span></span>
<span id="cb25-276"><a href="#cb25-276" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to remove accents</span></span>
<span id="cb25-277"><a href="#cb25-277" aria-hidden="true" tabindex="-1"></a><span class="in"># stri_trans_general is from `stringi` and is typically used in </span></span>
<span id="cb25-278"><a href="#cb25-278" aria-hidden="true" tabindex="-1"></a><span class="in"># script-to-script conversions and transliterations </span></span>
<span id="cb25-279"><a href="#cb25-279" aria-hidden="true" tabindex="-1"></a><span class="in"># https://www.rdocumentation.org/packages/stringi/versions/1.8.3/topics/stri_trans_general</span></span>
<span id="cb25-280"><a href="#cb25-280" aria-hidden="true" tabindex="-1"></a><span class="in">rm_accent &lt;- function(x){</span></span>
<span id="cb25-281"><a href="#cb25-281" aria-hidden="true" tabindex="-1"></a><span class="in">  x &lt;- stri_trans_general(x, "Latin-ASCII")</span></span>
<span id="cb25-282"><a href="#cb25-282" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb25-283"><a href="#cb25-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-284"><a href="#cb25-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-285"><a href="#cb25-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-286"><a href="#cb25-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo = TRUE, eval = FALSE}</span></span>
<span id="cb25-287"><a href="#cb25-287" aria-hidden="true" tabindex="-1"></a><span class="in"># removing accents</span></span>
<span id="cb25-288"><a href="#cb25-288" aria-hidden="true" tabindex="-1"></a><span class="in"># and str_to_lower() since R is case-sensitive</span></span>
<span id="cb25-289"><a href="#cb25-289" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw %&gt;% </span></span>
<span id="cb25-290"><a href="#cb25-290" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(state    = rm_accent(str_to_lower(state)), </span></span>
<span id="cb25-291"><a href="#cb25-291" aria-hidden="true" tabindex="-1"></a><span class="in">         municipality = rm_accent(str_to_lower(municipality)),</span></span>
<span id="cb25-292"><a href="#cb25-292" aria-hidden="true" tabindex="-1"></a><span class="in">         parrish = rm_accent(str_to_lower(parrish)),</span></span>
<span id="cb25-293"><a href="#cb25-293" aria-hidden="true" tabindex="-1"></a><span class="in">         location = rm_accent(str_to_lower(location)),</span></span>
<span id="cb25-294"><a href="#cb25-294" aria-hidden="true" tabindex="-1"></a><span class="in">         activity_description = rm_accent(str_to_lower(activity_description)))</span></span>
<span id="cb25-295"><a href="#cb25-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-296"><a href="#cb25-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-297"><a href="#cb25-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-298"><a href="#cb25-298" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-299"><a href="#cb25-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-300"><a href="#cb25-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-301"><a href="#cb25-301" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2c. One function for reading and cleaning</span></span>
<span id="cb25-302"><a href="#cb25-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-303"><a href="#cb25-303" aria-hidden="true" tabindex="-1"></a>We will now combine all this recoding into one function, organising our code better and improving readability. In dirtier datasets, sometimes partner names will need to be cleaned too (but that was done when this dataset was anonymised). To prevent data entry errors, we should just have been stricter about using dropdown tables. </span>
<span id="cb25-304"><a href="#cb25-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-305"><a href="#cb25-305" aria-hidden="true" tabindex="-1"></a>In fact, let us put all these steps right before the reading and consolidation loop so that data is cleaned as it is read into the consolidated dataset. Let's first amend the reading function: </span>
<span id="cb25-306"><a href="#cb25-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-307"><a href="#cb25-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-308"><a href="#cb25-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r reading-and-cleaning-function, echo=TRUE}</span></span>
<span id="cb25-309"><a href="#cb25-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-310"><a href="#cb25-310" aria-hidden="true" tabindex="-1"></a><span class="in"># If you haven't run it yet</span></span>
<span id="cb25-311"><a href="#cb25-311" aria-hidden="true" tabindex="-1"></a><span class="in">rm_accent &lt;- function(colns){</span></span>
<span id="cb25-312"><a href="#cb25-312" aria-hidden="true" tabindex="-1"></a><span class="in">  colns &lt;- stri_trans_general(colns, "Latin-ASCII")</span></span>
<span id="cb25-313"><a href="#cb25-313" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb25-314"><a href="#cb25-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-315"><a href="#cb25-315" aria-hidden="true" tabindex="-1"></a><span class="in">read_and_clean_5ws &lt;- function(file){</span></span>
<span id="cb25-316"><a href="#cb25-316" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb25-317"><a href="#cb25-317" aria-hidden="true" tabindex="-1"></a><span class="in">  read_excel(file, </span></span>
<span id="cb25-318"><a href="#cb25-318" aria-hidden="true" tabindex="-1"></a><span class="in">             sheet = 1, </span></span>
<span id="cb25-319"><a href="#cb25-319" aria-hidden="true" tabindex="-1"></a><span class="in">             col_types = df_col_types)|&gt;</span></span>
<span id="cb25-320"><a href="#cb25-320" aria-hidden="true" tabindex="-1"></a><span class="in">    janitor::clean_names()|&gt;</span></span>
<span id="cb25-321"><a href="#cb25-321" aria-hidden="true" tabindex="-1"></a><span class="in">    setNames(df_names) |&gt;</span></span>
<span id="cb25-322"><a href="#cb25-322" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(recurrent_beneficiaries = (recode(recurrent_beneficiaries, </span></span>
<span id="cb25-323"><a href="#cb25-323" aria-hidden="true" tabindex="-1"></a><span class="in">            "no" = "no", "No" = "no", </span></span>
<span id="cb25-324"><a href="#cb25-324" aria-hidden="true" tabindex="-1"></a><span class="in">            "Si" = "yes", "si" = "yes", "sí" = "yes", "Sí" = "yes")),  </span></span>
<span id="cb25-325"><a href="#cb25-325" aria-hidden="true" tabindex="-1"></a><span class="in">           activity_covid = recode(activity_covid, </span></span>
<span id="cb25-326"><a href="#cb25-326" aria-hidden="true" tabindex="-1"></a><span class="in">            "no" = "no", "No" = "no", </span></span>
<span id="cb25-327"><a href="#cb25-327" aria-hidden="true" tabindex="-1"></a><span class="in">            "Si" = "yes", "si" = "yes", "sí" = "yes", "Sí" = "yes")) |&gt;</span></span>
<span id="cb25-328"><a href="#cb25-328" aria-hidden="true" tabindex="-1"></a><span class="in">    # recoding NAs</span></span>
<span id="cb25-329"><a href="#cb25-329" aria-hidden="true" tabindex="-1"></a><span class="in">    replace_na(list(recurrent_beneficiaries = "no", activity_covid = "no")) |&gt;</span></span>
<span id="cb25-330"><a href="#cb25-330" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(activity_status = str_replace_all(activity_status, </span></span>
<span id="cb25-331"><a href="#cb25-331" aria-hidden="true" tabindex="-1"></a><span class="in">                                             c("En ejecucion" = "ejecucion", </span></span>
<span id="cb25-332"><a href="#cb25-332" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "en ejecución" = "ejecucion",</span></span>
<span id="cb25-333"><a href="#cb25-333" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "en Ejecución" = "ejecucion",</span></span>
<span id="cb25-334"><a href="#cb25-334" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "En ejecución" = "ejecucion",</span></span>
<span id="cb25-335"><a href="#cb25-335" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "En Ejecución" = "ejecucion",</span></span>
<span id="cb25-336"><a href="#cb25-336" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "finalizada" = "finalizada",</span></span>
<span id="cb25-337"><a href="#cb25-337" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "Finalizada" = "finalizada"))) |&gt; </span></span>
<span id="cb25-338"><a href="#cb25-338" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(state    = rm_accent(str_to_lower(state)), </span></span>
<span id="cb25-339"><a href="#cb25-339" aria-hidden="true" tabindex="-1"></a><span class="in">           municipality = rm_accent(str_to_lower(municipality)),</span></span>
<span id="cb25-340"><a href="#cb25-340" aria-hidden="true" tabindex="-1"></a><span class="in">           parrish = rm_accent(str_to_lower(parrish)),</span></span>
<span id="cb25-341"><a href="#cb25-341" aria-hidden="true" tabindex="-1"></a><span class="in">           location = rm_accent(str_to_lower(location)),</span></span>
<span id="cb25-342"><a href="#cb25-342" aria-hidden="true" tabindex="-1"></a><span class="in">           activity_description = rm_accent(str_to_lower(activity_description))) |&gt; </span></span>
<span id="cb25-343"><a href="#cb25-343" aria-hidden="true" tabindex="-1"></a><span class="in">    # Cleaning the date</span></span>
<span id="cb25-344"><a href="#cb25-344" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(month_reported = ceiling_date(month_reported, "month") - days(1))</span></span>
<span id="cb25-345"><a href="#cb25-345" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb25-346"><a href="#cb25-346" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb25-347"><a href="#cb25-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-348"><a href="#cb25-348" aria-hidden="true" tabindex="-1"></a><span class="in">path_5ws &lt;- "./data"</span></span>
<span id="cb25-349"><a href="#cb25-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-350"><a href="#cb25-350" aria-hidden="true" tabindex="-1"></a><span class="in"># Change the folder to the correct one</span></span>
<span id="cb25-351"><a href="#cb25-351" aria-hidden="true" tabindex="-1"></a><span class="in"># The files will be read from here </span></span>
<span id="cb25-352"><a href="#cb25-352" aria-hidden="true" tabindex="-1"></a><span class="in">file_list &lt;- list.files(path = path_5ws, </span></span>
<span id="cb25-353"><a href="#cb25-353" aria-hidden="true" tabindex="-1"></a><span class="in">                        recursive = TRUE, </span></span>
<span id="cb25-354"><a href="#cb25-354" aria-hidden="true" tabindex="-1"></a><span class="in">                        pattern = "\\.xlsx$", </span></span>
<span id="cb25-355"><a href="#cb25-355" aria-hidden="true" tabindex="-1"></a><span class="in">                        full.names = TRUE) </span></span>
<span id="cb25-356"><a href="#cb25-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-357"><a href="#cb25-357" aria-hidden="true" tabindex="-1"></a><span class="in"># Filtering out open files?</span></span>
<span id="cb25-358"><a href="#cb25-358" aria-hidden="true" tabindex="-1"></a><span class="in">file_list &lt;- file_list[!str_detect(file_list, "\\~")]</span></span>
<span id="cb25-359"><a href="#cb25-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-360"><a href="#cb25-360" aria-hidden="true" tabindex="-1"></a><span class="in"># Re-initialising the empty dataframe</span></span>
<span id="cb25-361"><a href="#cb25-361" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw &lt;- data.frame()</span></span>
<span id="cb25-362"><a href="#cb25-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-363"><a href="#cb25-363" aria-hidden="true" tabindex="-1"></a><span class="in"># Let us repeat the loop, with the new reading and cleaning function</span></span>
<span id="cb25-364"><a href="#cb25-364" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:length(file_list)) {</span></span>
<span id="cb25-365"><a href="#cb25-365" aria-hidden="true" tabindex="-1"></a><span class="in">  df_raw_i &lt;- read_and_clean_5ws(file_list[i])</span></span>
<span id="cb25-366"><a href="#cb25-366" aria-hidden="true" tabindex="-1"></a><span class="in">  df_raw &lt;- rbind(df_raw, df_raw_i)</span></span>
<span id="cb25-367"><a href="#cb25-367" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb25-368"><a href="#cb25-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-369"><a href="#cb25-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-370"><a href="#cb25-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-371"><a href="#cb25-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-372"><a href="#cb25-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-373"><a href="#cb25-373" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-374"><a href="#cb25-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-375"><a href="#cb25-375" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3. Cleaning locations </span></span>
<span id="cb25-376"><a href="#cb25-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-377"><a href="#cb25-377" aria-hidden="true" tabindex="-1"></a>Now that we have a consolidated, semi-clean dataset, let us now clean geographic and location data. </span>
<span id="cb25-378"><a href="#cb25-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-379"><a href="#cb25-379" aria-hidden="true" tabindex="-1"></a>We will first read in <span class="in">`locations.csv`</span>. This file comes from the official gazette of administrative areas and is typically available on HDX. The <span class="in">`locations.csv`</span> dataset also has schools and schools codes, in addition to state, municipality and parrish official names and pcodes, given that I was using it for the education cluster. </span>
<span id="cb25-380"><a href="#cb25-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-381"><a href="#cb25-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-382"><a href="#cb25-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read-locations, echo=TRUE}</span></span>
<span id="cb25-383"><a href="#cb25-383" aria-hidden="true" tabindex="-1"></a><span class="in">locations &lt;- read_csv("locations.csv", show_col_types = FALSE) %&gt;%</span></span>
<span id="cb25-384"><a href="#cb25-384" aria-hidden="true" tabindex="-1"></a><span class="in">  # Using the rm_accent() function from earlier</span></span>
<span id="cb25-385"><a href="#cb25-385" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(state  = rm_accent(str_to_lower(estado)), # just to make sure </span></span>
<span id="cb25-386"><a href="#cb25-386" aria-hidden="true" tabindex="-1"></a><span class="in">         municipality = rm_accent(str_to_lower(municipio)),</span></span>
<span id="cb25-387"><a href="#cb25-387" aria-hidden="true" tabindex="-1"></a><span class="in">         parrish = rm_accent(str_to_lower(parroquia)),</span></span>
<span id="cb25-388"><a href="#cb25-388" aria-hidden="true" tabindex="-1"></a><span class="in">         location = rm_accent(str_to_lower(ubicacion))) |&gt; </span></span>
<span id="cb25-389"><a href="#cb25-389" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-estado, -municipio, -parroquia, -ubicacion)</span></span>
<span id="cb25-390"><a href="#cb25-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-391"><a href="#cb25-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-392"><a href="#cb25-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-393"><a href="#cb25-393" aria-hidden="true" tabindex="-1"></a>We will also use an anti-join to identify new project sites which we should add to the location database. We won't be doing this in this exercise, but updating the project site database is important for verification, monitoring and accountability to affected populations. </span>
<span id="cb25-394"><a href="#cb25-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-395"><a href="#cb25-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-396"><a href="#cb25-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, locations-check, echo=TRUE}</span></span>
<span id="cb25-397"><a href="#cb25-397" aria-hidden="true" tabindex="-1"></a><span class="in"># see if you need to update locations </span></span>
<span id="cb25-398"><a href="#cb25-398" aria-hidden="true" tabindex="-1"></a><span class="in"># new locations not in locations.csv will be caught by the anti-join()</span></span>
<span id="cb25-399"><a href="#cb25-399" aria-hidden="true" tabindex="-1"></a><span class="in"> locations_add &lt;- df_raw %&gt;% </span></span>
<span id="cb25-400"><a href="#cb25-400" aria-hidden="true" tabindex="-1"></a><span class="in">   select(state, pcode1, municipality, pcode2, parrish, pcode3, location,</span></span>
<span id="cb25-401"><a href="#cb25-401" aria-hidden="true" tabindex="-1"></a><span class="in">          latitude, longitude) %&gt;% </span></span>
<span id="cb25-402"><a href="#cb25-402" aria-hidden="true" tabindex="-1"></a><span class="in">   distinct() %&gt;% </span></span>
<span id="cb25-403"><a href="#cb25-403" aria-hidden="true" tabindex="-1"></a><span class="in">   anti_join(locations, by = "location")</span></span>
<span id="cb25-404"><a href="#cb25-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-405"><a href="#cb25-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-406"><a href="#cb25-406" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-407"><a href="#cb25-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-408"><a href="#cb25-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-409"><a href="#cb25-409" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3b. Splitting the dataset into clean and dirty</span></span>
<span id="cb25-410"><a href="#cb25-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-411"><a href="#cb25-411" aria-hidden="true" tabindex="-1"></a>Let us identify the incomplete locations. We can see from the output that there are <span class="in">`r df_raw |&gt;filter(is.na(state) | is.na(pcode1) | is.na(municipality) | is.na(pcode2) | is.na(parrish) | is.na(pcode3)) |&gt; nrow()`</span> rows with missing geographic data. </span>
<span id="cb25-412"><a href="#cb25-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-413"><a href="#cb25-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-414"><a href="#cb25-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo = TRUE}</span></span>
<span id="cb25-415"><a href="#cb25-415" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw |&gt; </span></span>
<span id="cb25-416"><a href="#cb25-416" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(is.na(state) | is.na(pcode1) |</span></span>
<span id="cb25-417"><a href="#cb25-417" aria-hidden="true" tabindex="-1"></a><span class="in">         is.na(municipality) | is.na(pcode2) |</span></span>
<span id="cb25-418"><a href="#cb25-418" aria-hidden="true" tabindex="-1"></a><span class="in">         is.na(parrish) | is.na(pcode3)) |&gt; </span></span>
<span id="cb25-419"><a href="#cb25-419" aria-hidden="true" tabindex="-1"></a><span class="in">  nrow()</span></span>
<span id="cb25-420"><a href="#cb25-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-421"><a href="#cb25-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-422"><a href="#cb25-422" aria-hidden="true" tabindex="-1"></a>We will split off these rows to be cleaned. We will combine it back together later. </span>
<span id="cb25-423"><a href="#cb25-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-424"><a href="#cb25-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-425"><a href="#cb25-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r split-clean-dirty, echo=TRUE}</span></span>
<span id="cb25-426"><a href="#cb25-426" aria-hidden="true" tabindex="-1"></a><span class="in"># splitting into two datasets, one clean one dirty. </span></span>
<span id="cb25-427"><a href="#cb25-427" aria-hidden="true" tabindex="-1"></a><span class="in">locations_dirty &lt;- df_raw %&gt;% </span></span>
<span id="cb25-428"><a href="#cb25-428" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(is.na(state) | is.na(pcode1) |</span></span>
<span id="cb25-429"><a href="#cb25-429" aria-hidden="true" tabindex="-1"></a><span class="in">         is.na(municipality) | is.na(pcode2) |</span></span>
<span id="cb25-430"><a href="#cb25-430" aria-hidden="true" tabindex="-1"></a><span class="in">         is.na(parrish) | is.na(pcode3))</span></span>
<span id="cb25-431"><a href="#cb25-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-432"><a href="#cb25-432" aria-hidden="true" tabindex="-1"></a><span class="in">locations_clean &lt;- df_raw %&gt;% </span></span>
<span id="cb25-433"><a href="#cb25-433" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(state) &amp; !is.na(pcode1) &amp;</span></span>
<span id="cb25-434"><a href="#cb25-434" aria-hidden="true" tabindex="-1"></a><span class="in">         !is.na(municipality) &amp; !is.na(pcode2) &amp;</span></span>
<span id="cb25-435"><a href="#cb25-435" aria-hidden="true" tabindex="-1"></a><span class="in">         !is.na(parrish) &amp; !is.na(pcode3)) </span></span>
<span id="cb25-436"><a href="#cb25-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-437"><a href="#cb25-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-438"><a href="#cb25-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-439"><a href="#cb25-439" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-440"><a href="#cb25-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-441"><a href="#cb25-441" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3c. Fill in missing values with `coalesce()`</span></span>
<span id="cb25-442"><a href="#cb25-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-443"><a href="#cb25-443" aria-hidden="true" tabindex="-1"></a>The <span class="in">`locations.csv`</span> reference dataset is used to clean <span class="in">`locations_dirty`</span> and rewrite it. The <span class="in">`distinct()`</span> call at the end is to ensure that there are no duplicates. After which, we combine <span class="in">`locations_clean`</span> and <span class="in">`locations_dirty`</span> into <span class="in">`df_raw_locations`</span>. </span>
<span id="cb25-444"><a href="#cb25-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-445"><a href="#cb25-445" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-446"><a href="#cb25-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-447"><a href="#cb25-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-448"><a href="#cb25-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fill in missing values, echo=TRUE}</span></span>
<span id="cb25-449"><a href="#cb25-449" aria-hidden="true" tabindex="-1"></a><span class="in"># filling in missing values</span></span>
<span id="cb25-450"><a href="#cb25-450" aria-hidden="true" tabindex="-1"></a><span class="in">locations_dirty &lt;- locations_dirty %&gt;% </span></span>
<span id="cb25-451"><a href="#cb25-451" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(locations, by = "location") %&gt;% </span></span>
<span id="cb25-452"><a href="#cb25-452" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(state    = coalesce(state.x, state.y),</span></span>
<span id="cb25-453"><a href="#cb25-453" aria-hidden="true" tabindex="-1"></a><span class="in">         pcode1    = coalesce(pcode1.x, pcode1.y),</span></span>
<span id="cb25-454"><a href="#cb25-454" aria-hidden="true" tabindex="-1"></a><span class="in">         municipality = coalesce(municipality.x, municipality.y),</span></span>
<span id="cb25-455"><a href="#cb25-455" aria-hidden="true" tabindex="-1"></a><span class="in">         pcode2    = coalesce(pcode2.x, pcode2.y),</span></span>
<span id="cb25-456"><a href="#cb25-456" aria-hidden="true" tabindex="-1"></a><span class="in">         parrish = coalesce(parrish.x, parrish.y),</span></span>
<span id="cb25-457"><a href="#cb25-457" aria-hidden="true" tabindex="-1"></a><span class="in">         pcode3    = coalesce(pcode3.x, pcode3.y)) %&gt;% </span></span>
<span id="cb25-458"><a href="#cb25-458" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-state.x, -state.y, -pcode1.x, -pcode1.y,</span></span>
<span id="cb25-459"><a href="#cb25-459" aria-hidden="true" tabindex="-1"></a><span class="in">         -municipality.x, -municipality.y, -pcode2.x, -pcode2.y,</span></span>
<span id="cb25-460"><a href="#cb25-460" aria-hidden="true" tabindex="-1"></a><span class="in">         -parrish.x, -parrish.y, -pcode3.x, -pcode3.y) %&gt;% </span></span>
<span id="cb25-461"><a href="#cb25-461" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct() # removing duplicate rows from the join </span></span>
<span id="cb25-462"><a href="#cb25-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-463"><a href="#cb25-463" aria-hidden="true" tabindex="-1"></a><span class="in"># bind_rows() does not care about column sequence </span></span>
<span id="cb25-464"><a href="#cb25-464" aria-hidden="true" tabindex="-1"></a><span class="in"># but put adm_clean first so that the original order is preserved</span></span>
<span id="cb25-465"><a href="#cb25-465" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw_locations &lt;- bind_rows(locations_clean, locations_dirty)</span></span>
<span id="cb25-466"><a href="#cb25-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-467"><a href="#cb25-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-468"><a href="#cb25-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-469"><a href="#cb25-469" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-470"><a href="#cb25-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-471"><a href="#cb25-471" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3d. Error checking the join</span></span>
<span id="cb25-472"><a href="#cb25-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-473"><a href="#cb25-473" aria-hidden="true" tabindex="-1"></a>Printing out the sum of the <span class="in">`total_beneficiaries`</span> and the number of rows in <span class="in">`df_raw`</span>(original dataset) and <span class="in">`df_raw_locations`</span>(updated, with the locations cleaned). </span>
<span id="cb25-474"><a href="#cb25-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-475"><a href="#cb25-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-476"><a href="#cb25-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r join-error-check, echo = TRUE}</span></span>
<span id="cb25-477"><a href="#cb25-477" aria-hidden="true" tabindex="-1"></a><span class="in"># error checking</span></span>
<span id="cb25-478"><a href="#cb25-478" aria-hidden="true" tabindex="-1"></a><span class="in">rbind(sum(df_raw$total_beneficiaries, na.rm = TRUE),</span></span>
<span id="cb25-479"><a href="#cb25-479" aria-hidden="true" tabindex="-1"></a><span class="in">      sum(df_raw_locations$total_beneficiaries, na.rm = TRUE),</span></span>
<span id="cb25-480"><a href="#cb25-480" aria-hidden="true" tabindex="-1"></a><span class="in">      nrow(df_raw),</span></span>
<span id="cb25-481"><a href="#cb25-481" aria-hidden="true" tabindex="-1"></a><span class="in">      nrow(df_raw_locations))</span></span>
<span id="cb25-482"><a href="#cb25-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-483"><a href="#cb25-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-484"><a href="#cb25-484" aria-hidden="true" tabindex="-1"></a>Everything seems in order, and we have not duplicated or dropped any rows from the original dataset. </span>
<span id="cb25-485"><a href="#cb25-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-486"><a href="#cb25-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-487"><a href="#cb25-487" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-488"><a href="#cb25-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-489"><a href="#cb25-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-490"><a href="#cb25-490" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4. Beneficiary disaggregation </span></span>
<span id="cb25-491"><a href="#cb25-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-492"><a href="#cb25-492" aria-hidden="true" tabindex="-1"></a>Let us next check on the beneficiary disaggregations by comparing the sum of all disaggregated beneficiaries against the reported total. We will mutate two new columns: <span class="in">`total_disagg_ben`</span>, which is the sum of all sex and age-disaggregated beneficiaries and <span class="in">`no_disagg_ben`</span> for beneficiaries reported without sex and age information. Depending on reporting standards of each cluster, we will have different uses for the disaggregated and non-disaggregated numbers. </span>
<span id="cb25-493"><a href="#cb25-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-494"><a href="#cb25-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-495"><a href="#cb25-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-496"><a href="#cb25-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bencheck-and-no-esp-ben, echo=TRUE }</span></span>
<span id="cb25-497"><a href="#cb25-497" aria-hidden="true" tabindex="-1"></a><span class="in"># mutating bencheck and unspecified beneficiaries columns </span></span>
<span id="cb25-498"><a href="#cb25-498" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw_locations &lt;- df_raw_locations %&gt;% </span></span>
<span id="cb25-499"><a href="#cb25-499" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(total_disagg_ben = select(., m_0_3:m_19_and_older) %&gt;%  rowSums(na.rm = TRUE), </span></span>
<span id="cb25-500"><a href="#cb25-500" aria-hidden="true" tabindex="-1"></a><span class="in">         no_disagg_ben = round(total_beneficiaries) - round(total_disagg_ben)) </span></span>
<span id="cb25-501"><a href="#cb25-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-502"><a href="#cb25-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-503"><a href="#cb25-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-504"><a href="#cb25-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-505"><a href="#cb25-505" aria-hidden="true" tabindex="-1"></a>Let us print the rows where the sum of disaggregated beneficiaries (<span class="in">`total_disagg_ben`</span>) does not match the totals reported in the <span class="in">`total_beneficiaries`</span> column, so that we can return to the relevant parties for follow up. </span>
<span id="cb25-506"><a href="#cb25-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-507"><a href="#cb25-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-508"><a href="#cb25-508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r printing-bencheck}</span></span>
<span id="cb25-509"><a href="#cb25-509" aria-hidden="true" tabindex="-1"></a><span class="in"># printing the bencheck</span></span>
<span id="cb25-510"><a href="#cb25-510" aria-hidden="true" tabindex="-1"></a><span class="in"># the round is necessary due to floating point arithmetic as some values are</span></span>
<span id="cb25-511"><a href="#cb25-511" aria-hidden="true" tabindex="-1"></a><span class="in"># close enough to 0 to be ignored by us but not by R. </span></span>
<span id="cb25-512"><a href="#cb25-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-513"><a href="#cb25-513" aria-hidden="true" tabindex="-1"></a><span class="in">df_raw_locations %&gt;% </span></span>
<span id="cb25-514"><a href="#cb25-514" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(round(total_beneficiaries) != round(total_disagg_ben)) %&gt;% </span></span>
<span id="cb25-515"><a href="#cb25-515" aria-hidden="true" tabindex="-1"></a><span class="in">  select(implementing_partner, activity_description, </span></span>
<span id="cb25-516"><a href="#cb25-516" aria-hidden="true" tabindex="-1"></a><span class="in">         location, total_disagg_ben, total_beneficiaries, no_disagg_ben) |&gt; </span></span>
<span id="cb25-517"><a href="#cb25-517" aria-hidden="true" tabindex="-1"></a><span class="in">  kable(caption = "Undisaggregated beneficiaries") %&gt;%</span></span>
<span id="cb25-518"><a href="#cb25-518" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(bootstrap_options = "bordered", font_size = 12, full_width = FALSE)</span></span>
<span id="cb25-519"><a href="#cb25-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-520"><a href="#cb25-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-521"><a href="#cb25-521" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-522"><a href="#cb25-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-523"><a href="#cb25-523" aria-hidden="true" tabindex="-1"></a>In this scenario, we would have returned to these three partners and asked for corrections. </span>
<span id="cb25-524"><a href="#cb25-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-525"><a href="#cb25-525" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-526"><a href="#cb25-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-527"><a href="#cb25-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-528"><a href="#cb25-528" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5. Outputs</span></span>
<span id="cb25-529"><a href="#cb25-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-530"><a href="#cb25-530" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5a. Cleaned wide version</span></span>
<span id="cb25-531"><a href="#cb25-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-532"><a href="#cb25-532" aria-hidden="true" tabindex="-1"></a>We can now share a clean version of the wide file with OCHA, they will generally prefer a wide table, in the same shape as the 5W form: </span>
<span id="cb25-533"><a href="#cb25-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-534"><a href="#cb25-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cleaned-wide, echo=TRUE, eval=FALSE}</span></span>
<span id="cb25-535"><a href="#cb25-535" aria-hidden="true" tabindex="-1"></a><span class="in"># turn on eval if you want the file</span></span>
<span id="cb25-536"><a href="#cb25-536" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(df_raw_locations, paste0(format(Sys.time(), "%y%m%d_%H%M_"), "5W_wide.csv"))</span></span>
<span id="cb25-537"><a href="#cb25-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-538"><a href="#cb25-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-539"><a href="#cb25-539" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-540"><a href="#cb25-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-541"><a href="#cb25-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-542"><a href="#cb25-542" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5b. Unique beneficiaries</span></span>
<span id="cb25-543"><a href="#cb25-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-544"><a href="#cb25-544" aria-hidden="true" tabindex="-1"></a>This section pivots the dataset longer into a tidy format -- normal 5W templates tend to "wide", with the totals and beneficiary disaggregations all in one row. We use a long format to make things easier for plotting and analysis. </span>
<span id="cb25-545"><a href="#cb25-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-546"><a href="#cb25-546" aria-hidden="true" tabindex="-1"></a>We will also create the dataset <span class="in">`unique_ben`</span> to aid in our estimations of the actual reach of the programme. This is distinct from the concept of a beneficiary frequency, which is one person reached by one activity and does not account for double counting. </span>
<span id="cb25-547"><a href="#cb25-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-548"><a href="#cb25-548" aria-hidden="true" tabindex="-1"></a>Unique beneficiaries are the individuals who have been reached by at least one programme activity. Frequencies are important for budgetary reasons and to show the full scale of the programme. Unique beneficiaries show a more accurate picture of the programme's footprint and are very useful for coordinating activities with other clusters. </span>
<span id="cb25-549"><a href="#cb25-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-550"><a href="#cb25-550" aria-hidden="true" tabindex="-1"></a>The gold standard for avoiding double counting is the deployment of a beneficiary database. However, most agencies are not able to do this. In lieu of that, to avoid double counting and estimate the number of unique beneficiaries, we will only add the highest number of beneficiaries reached at each project site (location). </span>
<span id="cb25-551"><a href="#cb25-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-552"><a href="#cb25-552" aria-hidden="true" tabindex="-1"></a>At this point, we will also filter out the activity CA1.05, which the promotion of key messages for the education community, specifically, we will filter out all activities where the location is "radio" or "fm station". Mass messaging activities do not typically count towards beneficiary totals as they are quite light-touch, especially in comparison to education kits, school feeding or work with out-of-school children. If need be, we can always analyse the radio messaging activity on its own. </span>
<span id="cb25-553"><a href="#cb25-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-554"><a href="#cb25-554" aria-hidden="true" tabindex="-1"></a>Ideally, we would codify all this by developing indicator guidance for the cluster, though it did take a few years for the office to systematise.  </span>
<span id="cb25-555"><a href="#cb25-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-556"><a href="#cb25-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-557"><a href="#cb25-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r unique-benficiaries, echo=TRUE}</span></span>
<span id="cb25-558"><a href="#cb25-558" aria-hidden="true" tabindex="-1"></a><span class="in"># pivoting longer and creating new dataframe</span></span>
<span id="cb25-559"><a href="#cb25-559" aria-hidden="true" tabindex="-1"></a><span class="in">unique_ben &lt;- df_raw_locations |&gt; </span></span>
<span id="cb25-560"><a href="#cb25-560" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!str_detect(location, "radio|fm")) |&gt; </span></span>
<span id="cb25-561"><a href="#cb25-561" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-total_disagg_ben) |&gt; </span></span>
<span id="cb25-562"><a href="#cb25-562" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(m_0_3:no_disagg_ben, </span></span>
<span id="cb25-563"><a href="#cb25-563" aria-hidden="true" tabindex="-1"></a><span class="in">               names_to = "disaggregation", values_to = "beneficiaries") |&gt;  </span></span>
<span id="cb25-564"><a href="#cb25-564" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(recurrent_beneficiaries == "no") |&gt; </span></span>
<span id="cb25-565"><a href="#cb25-565" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(beneficiaries != 0) %&gt;% # empty cells are 0 in the 5W table</span></span>
<span id="cb25-566"><a href="#cb25-566" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(location, disaggregation)|&gt; </span></span>
<span id="cb25-567"><a href="#cb25-567" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(which.max(beneficiaries)) |&gt;  </span></span>
<span id="cb25-568"><a href="#cb25-568" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt;  </span></span>
<span id="cb25-569"><a href="#cb25-569" aria-hidden="true" tabindex="-1"></a><span class="in">  select(month_reported, state, pcode1, municipality, pcode2,</span></span>
<span id="cb25-570"><a href="#cb25-570" aria-hidden="true" tabindex="-1"></a><span class="in">       parrish, pcode3, location, latitude, longitude, </span></span>
<span id="cb25-571"><a href="#cb25-571" aria-hidden="true" tabindex="-1"></a><span class="in">       disaggregation, beneficiaries)</span></span>
<span id="cb25-572"><a href="#cb25-572" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-573"><a href="#cb25-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-574"><a href="#cb25-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-575"><a href="#cb25-575" aria-hidden="true" tabindex="-1"></a><span class="in">```{r writing-u-ben-csv, echo=TRUE, eval=FALSE}</span></span>
<span id="cb25-576"><a href="#cb25-576" aria-hidden="true" tabindex="-1"></a><span class="in"># writing csv of unique_ben with datestamp</span></span>
<span id="cb25-577"><a href="#cb25-577" aria-hidden="true" tabindex="-1"></a><span class="in"># turn on eval if you want the file </span></span>
<span id="cb25-578"><a href="#cb25-578" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(unique_ben, paste0(format(Sys.time(), "%y%m%d_%H%M_"), "unique_ben.csv"))</span></span>
<span id="cb25-579"><a href="#cb25-579" aria-hidden="true" tabindex="-1"></a><span class="in"># Without date stamp</span></span>
<span id="cb25-580"><a href="#cb25-580" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(unique_ben, paste0("unique_ben.csv"))</span></span>
<span id="cb25-581"><a href="#cb25-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-582"><a href="#cb25-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-583"><a href="#cb25-583" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-584"><a href="#cb25-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-585"><a href="#cb25-585" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5c. Beneficiaries by activity</span></span>
<span id="cb25-586"><a href="#cb25-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-587"><a href="#cb25-587" aria-hidden="true" tabindex="-1"></a>Let us also make the dataset <span class="in">`activity_ben`</span> for activity-wise analysis. As with <span class="in">`unique_ben`</span>, recurrent beneficiaries have been filtered out. Similar to <span class="in">`unique_ben`</span>, this dataset has also been pivoted longer into a tidy format. </span>
<span id="cb25-588"><a href="#cb25-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-589"><a href="#cb25-589" aria-hidden="true" tabindex="-1"></a>Please note that there is double counting in this dataset as beneficiaries might have been reached by more than one activity. For geographic analysis, please use <span class="in">`unique_ben`</span>. </span>
<span id="cb25-590"><a href="#cb25-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-591"><a href="#cb25-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-592"><a href="#cb25-592" aria-hidden="true" tabindex="-1"></a><span class="in">```{r beneficiaries-by-activity, echo=TRUE}</span></span>
<span id="cb25-593"><a href="#cb25-593" aria-hidden="true" tabindex="-1"></a><span class="in"># This is the dataset for beneficiaries</span></span>
<span id="cb25-594"><a href="#cb25-594" aria-hidden="true" tabindex="-1"></a><span class="in">activity_ben &lt;- df_raw_locations |&gt; </span></span>
<span id="cb25-595"><a href="#cb25-595" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!str_detect(location, "radio|fm")) |&gt; </span></span>
<span id="cb25-596"><a href="#cb25-596" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-total_disagg_ben) |&gt; </span></span>
<span id="cb25-597"><a href="#cb25-597" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(m_0_3:no_disagg_ben, </span></span>
<span id="cb25-598"><a href="#cb25-598" aria-hidden="true" tabindex="-1"></a><span class="in">               names_to = "disaggregation", values_to = "beneficiaries") |&gt;  </span></span>
<span id="cb25-599"><a href="#cb25-599" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(recurrent_beneficiaries == "no") |&gt; </span></span>
<span id="cb25-600"><a href="#cb25-600" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(beneficiaries != 0) %&gt;% # empty cells are 0 in the 5W table</span></span>
<span id="cb25-601"><a href="#cb25-601" aria-hidden="true" tabindex="-1"></a><span class="in">  select(month_reported, project_name, implementing_partner, </span></span>
<span id="cb25-602"><a href="#cb25-602" aria-hidden="true" tabindex="-1"></a><span class="in">         state, pcode1, municipality, pcode2, </span></span>
<span id="cb25-603"><a href="#cb25-603" aria-hidden="true" tabindex="-1"></a><span class="in">         parrish, pcode3, location, latitude, longitude, </span></span>
<span id="cb25-604"><a href="#cb25-604" aria-hidden="true" tabindex="-1"></a><span class="in">         activity_code, activity_description, activity_covid,</span></span>
<span id="cb25-605"><a href="#cb25-605" aria-hidden="true" tabindex="-1"></a><span class="in">         disaggregation, beneficiaries)</span></span>
<span id="cb25-606"><a href="#cb25-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-607"><a href="#cb25-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-608"><a href="#cb25-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-609"><a href="#cb25-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-610"><a href="#cb25-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-611"><a href="#cb25-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r writing-act-ben-csv, echo=TRUE, eval=FALSE}</span></span>
<span id="cb25-612"><a href="#cb25-612" aria-hidden="true" tabindex="-1"></a><span class="in"># writing csv activity_ben with datestamp</span></span>
<span id="cb25-613"><a href="#cb25-613" aria-hidden="true" tabindex="-1"></a><span class="in"># turn on eval if you want the file </span></span>
<span id="cb25-614"><a href="#cb25-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-615"><a href="#cb25-615" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(activity_ben, paste0(format(Sys.time(), "%y%m%d_%H%M_"), "activity_ben.csv"))</span></span>
<span id="cb25-616"><a href="#cb25-616" aria-hidden="true" tabindex="-1"></a><span class="in"># Without date stamp</span></span>
<span id="cb25-617"><a href="#cb25-617" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(activity_ben, paste0("activity_ben.csv"))</span></span>
<span id="cb25-618"><a href="#cb25-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-619"><a href="#cb25-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-620"><a href="#cb25-620" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;&lt;br&gt;</span>
<span id="cb25-621"><a href="#cb25-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-622"><a href="#cb25-622" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5d. Comparing `unique_ben`, `activity_ben` and difference</span></span>
<span id="cb25-623"><a href="#cb25-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-624"><a href="#cb25-624" aria-hidden="true" tabindex="-1"></a>Printed below are the numbers of unique beneficiaries, beneficiary frequencies and the difference between the two figures.</span>
<span id="cb25-625"><a href="#cb25-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-626"><a href="#cb25-626" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-627"><a href="#cb25-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-628"><a href="#cb25-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r comparing}</span></span>
<span id="cb25-629"><a href="#cb25-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-630"><a href="#cb25-630" aria-hidden="true" tabindex="-1"></a><span class="in">rbind(sum(unique_ben$beneficiaries),</span></span>
<span id="cb25-631"><a href="#cb25-631" aria-hidden="true" tabindex="-1"></a><span class="in">      sum(activity_ben$beneficiaries),</span></span>
<span id="cb25-632"><a href="#cb25-632" aria-hidden="true" tabindex="-1"></a><span class="in">      sum(unique_ben$beneficiaries) - sum(activity_ben$beneficiaries))</span></span>
<span id="cb25-633"><a href="#cb25-633" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-634"><a href="#cb25-634" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb25-635"><a href="#cb25-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-636"><a href="#cb25-636" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Click through</span><span class="co">](https://seanywng.github.io/5W/reporting_5ws_english)</span> to the next part, where will go through 5W reporting and make use the cleaned datasets. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>